function getMiddle(e){var o=e.getLatLngs()[0],a=e.getLatLngs()[1];return new L.LatLng(o.lat+(a.lat-o.lat)/2,o.lng+(a.lng-o.lng)/2)}function splitPolyline(e){if(2===e.Waypoints.length&&e.DummyHandle instanceof Waypoint){var o=(e.Waypoints[0],e.DummyHandle),a=e.Waypoints[1];return o.RemoveFromPolyline(e),e.DummyHandle=void 0,o.AddToPolyline(e),a.RemoveFromPolyline(e),addDummyHandle(e),void addDummyHandle(mapViewModel.AddPolyline([o,a]))}throw new Error("Cannot split polyline. Polyline has no dummy handle or less or more than 2 waypoints")}function removePolyline(e){for(var o=0,a=e.Waypoints;o<a.length;o++){var i=a[o];i.RemoveFromPolyline(e)}void 0!==e.DummyHandle&&(e.DummyHandle.RemoveFromPolyline(e),e.DummyHandle.RemoveFromMap()),mapViewModel.Map.removeLayer(e)}function addDummyHandle(e){void 0===e.DummyHandle&&(e.DummyHandle=mapViewModel.CreateWaypoint(getMiddle(e),MarkerType.Dummy),e.DummyHandle.AddToPolyline(e))}function redrawPolyline(e){var o=getMiddle(e);void 0===e.DummyHandle&&addDummyHandle(e),e.DummyHandle.Longitude()!==o.lng||e.DummyHandle.Latitude()!==o.lat?e.DummyHandle.SetLatLng(o):e.redraw()}function removeFromPolyline(e,o){removeFromArray(e.getLatLngs(),o),e.redraw()}function removeFromArray(e,o){for(var a=new Array,i=0,t=e;i<t.length;i++){var n=t[i];n!==o&&a.push(n)}if(a.length===e.length)return!1;for(;e.pop(););for(;a.length>0;)e.push(a.shift());return!0}var SHarbour=ServerModel.Harbour,Waypoint=ClientModel.Waypoint,Harbour=ClientModel.Harbour,Job=ClientModel.Job,WaypointDistance=ClientModel.WaypointDistance,MapMode;!function(e){e[e.Admin=0]="Admin",e[e.View=1]="View",e[e.TripPlanning=2]="TripPlanning",e[e.RouteDrawing=3]="RouteDrawing"}(MapMode||(MapMode={}));var MapViewModel=function(){function e(e){var o=this;this.routePolyline=ko.observable(),this.IsLastTakInRoute=ko.computed({read:function(){var e=mapViewModel.SelectedTrip(),o=mapViewModel.SelectedHarbour();return void 0!==e&&void 0!==o&&e.Tacks()[e.Tacks().length-1].Start()===o},deferEvaluation:!0}),this.GetRouteDistance=ko.computed({read:function(){for(var e=0,o=0,a=mapViewModel.SelectedTrip().Tacks();o<a.length;o++){var i=a[o];isNaN(i.Distance())||(e+=i.Distance())}return e},deferEvaluation:!0}),this.TopJobs=ko.computed({read:function(){return mapViewModel.Jobs().filter(function(e){return void 0===e.SuperJobId()})},deferEvaluation:!0}),this.IsInViewMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.View},deferEvaluation:!0}),this.IsInAdminMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.Admin},deferEvaluation:!0}),this.WaypointsLoaded=!1,this.WaypointConnectionsLoaded=!1,this.PersonsLoaded=!1,this.JobsLoaded=!1,this.TripsLoaded=!1,this.AddressesLoaded=!1,this.ImagesLoaded=!1,this.AlbumsLoaded=!1,this.WaypointTacksLoaded=!1,this.TacksLoaded=!1,this.LocationsLoaded=!1,this.AlbumImagesLoaded=!1,this.Waypoints=ko.observableArray(),this.WaypointConnections=ko.observableArray(),this.Harbours=ko.observableArray(),this.Persons=ko.observableArray(),this.Jobs=ko.observableArray(),this.Trips=ko.observableArray(),this.Addresses=ko.observableArray(),this.Images=ko.observableArray(),this.Tacks=ko.observableArray(),this.Locations=ko.observableArray(),this.Supermarkets=ko.observableArray(),this.Restaurants=ko.observableArray(),this.Albums=ko.observableArray(),this.AlbumImages=ko.observableArray(),this.SelectedWaypoint=ko.observable(),this.SelectedHarbour=ko.observable(),this.SelectedPerson=ko.observable(),this.SelectedJob=ko.observable(),this.SelectedTrip=ko.observable(),this.SelectedAddress=ko.observable(),this.SelectedImage=ko.observable(),this.SelectedTack=ko.observable(),this.SelectedLocation=ko.observable(),this.SelectedSupermarket=ko.observable(),this.SelectedRestaurant=ko.observable(),this.RemoveHarbour=function(){mapViewModel.SelectedWaypoint().RemoveFromMap(),mapViewModel.Waypoints.remove(o.SelectedWaypoint())},this.RemoveWaypoint=function(){mapViewModel.SelectedHarbour().RemoveFromMap(),mapViewModel.Harbours.remove(o.SelectedHarbour()),mapViewModel.Harbours.remove(o.SelectedHarbour())},this.MapMode=ko.observable(),this.RemovePolyline=function(e){o.Map.removeLayer(e),o.DrawingPolyline=void 0},this.routeFixed=!1,this.noRevertToPreviousBounds=!1,this.Polylines=new Array,this.EditingHarbour=ko.observable(),this.DeletingHarbour=ko.observable(),this.EditingWaypoint=ko.observable(),this.DeletingWaypoint=ko.observable(),this.DeletingJob=ko.observable(),this.EditingJob=ko.observable(),this.WaypointMarkers=new Array,L.mapbox.accessToken="pk.eyJ1IjoiZGFuaWVsLWt1b24iLCJhIjoiY2lldnVtY29iMDBiOHQxbTBvZzBqZWl6cCJ9.UEc2YqH59pB1YTpv22vg8A",this.MapMode(e),this.MapMode.subscribe(function(){o.InitializeMap()});var a={contextmenu:e===MapMode.Admin,contextmenuItems:[{text:"Neuer Hafen",callback:function(e){console.log(e),mapViewModel.EditingHarbour(mapViewModel.CreateHarbour("",e.latlng))}}]};this.Map=L.mapbox.map("map","mapbox.streets",a),this.Map.setView([54.40774166820069,10.523529052734373],9),L.tileLayer("http://t1.openseamap.org/seamark/{z}/{x}/{y}.png").addTo(this.Map),this.LoadData(),this.SelectedHarbour.subscribe(function(e){if(void 0!==e)mapViewModel.CalculateDistances(e),mapViewModel.Harbours.sort(function(e,o){return e.Distance()-o.Distance()});else for(var o=0,a=mapViewModel.Harbours();o<a.length;o++){var i=a[o];i.Distance(0)}mapViewModel.routeFixed=!1,mapViewModel.HideRoute()}),this.EditingHarbour.subscribe(function(e){void 0===e?editingHarbourModal.modal("hide"):(e.SaveState(),editingHarbourModal.modal("show"))}),this.EditingHarbour.subscribe(function(e){void 0!==e&&(e.RevertState(!0),void 0===e.Id()&&mapViewModel.Map.removeLayer(e.marker))},this,"beforeChange"),this.DeletingHarbour.subscribe(function(e){void 0===e?deletingHarbourModal.modal("hide"):deletingHarbourModal.modal("show")}),this.EditingWaypoint.subscribe(function(e){void 0===e?editingWaypointModal.modal("hide"):(e.SaveState(),editingWaypointModal.modal("show"))}),this.EditingWaypoint.subscribe(function(e){void 0!==mapViewModel.EditingWaypoint()&&mapViewModel.EditingWaypoint().RevertState(!0)},this,"beforeChange"),this.DeletingWaypoint.subscribe(function(e){void 0===e?deletingWaypointModal.modal("hide"):deletingWaypointModal.modal("show")}),this.EditingJob.subscribe(function(e){void 0===e?editingJobModal.modal("hide"):(e.SaveState(),editingJobModal.modal("show"))}),this.EditingJob.subscribe(function(e){void 0!==mapViewModel.EditingJob()&&mapViewModel.EditingJob().RevertState(!0)},this,"beforeChange"),this.DeletingJob.subscribe(function(e){void 0===e?deletingJobModal.modal("hide"):deletingJobModal.modal("show")}),this.SelectedHarbour.subscribe(function(e){void 0===e?rightSidebar.Hide():rightSidebar.Show()}),this.SelectedTrip.subscribe(function(e){void 0===e?bottomSidebar.Hide():bottomSidebar.Show()}),this.Map.addEventListener("mousemove",function(e){if(o.GetMapMode()===MapMode.RouteDrawing&&(o.DrawingLatLng.lat=e.latlng.lat,o.DrawingLatLng.lng=e.latlng.lng,o.DrawingPolyline.redraw()),o.MapMode()===MapMode.Admin)for(var a=0,i=o.WaypointMarkers;a<i.length;a++){var t=i[a];t.Point.distanceTo(e.containerPoint)<150?t.setOpacity(t.Waypoint.IsDummy()?0:1):t.setOpacity(t.Waypoint.IsDummy()?0:.8)}if(void 0!==mapViewModel.HoveredPolyine&&void 0!==mapViewModel.HoveredPolyine.DummyHandle){var n=mapViewModel.HoveredPolyine,r=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[0]),d=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[1]);r.distanceTo(e.containerPoint)<20||d.distanceTo(e.containerPoint)<20?mapViewModel.HoveredPolyine=void 0:(mapViewModel.HoveredPolyine.DummyHandle.marker.setOpacity(.8),mapViewModel.HoveredPolyine.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,r,d)),!1))}}),this.Map.addEventListener("click",function(e){if(o.GetMapMode()===MapMode.RouteDrawing){var a=mapViewModel.CreateWaypoint(e.latlng,MarkerType.Waypoint),i=o.DrawingPolyline.Waypoints[0].Id();a.SaveToServer().done(function(e){ServerApi.WaypointConnectionApi.GetDefault().Connect(e.Id,i)}),a.AddToPolyline(o.DrawingPolyline),addDummyHandle(o.DrawingPolyline),removeFromPolyline(o.DrawingPolyline,o.DrawingLatLng),o.DrawingPolyline=o.AddPolyline(a),o.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),o.DrawingPolyline.addLatLng(o.DrawingLatLng)}}),this.Map.addEventListener("dblclick",function(e){o.GetMapMode()===MapMode.RouteDrawing&&(e.originalEvent.cancelBubble=!0,e.originalEvent.preventDefault(),e.originalEvent.stopPropagation(),o.DrawingPolyline.addLatLng(e.latlng),o.DrawingLatLng=e.latlng)}),$(document).keyup(function(e){o.GetMapMode()===MapMode.RouteDrawing&&27===e.keyCode&&o.RemovePolyline(o.DrawingPolyline)}),this.Map.addEventListener("move",function(e){for(var a=0,i=o.WaypointMarkers;a<i.length;a++){var t=i[a];t.Point=o.Map.latLngToContainerPoint(t.getLatLng())}}),this.Map.addEventListener("zoom",function(e){for(var a=0,i=o.WaypointMarkers;a<i.length;a++){var t=i[a];t.Point=o.Map.latLngToContainerPoint(t.getLatLng())}})}return e.prototype.StartRoute=function(){var e=new ClientModel.Trip,o=new ClientModel.Tack,a=mapViewModel.SelectedHarbour();o.Start(a),e.Tacks.push(o),mapViewModel.SelectedTrip(e),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map)},e.prototype.AddToRoute=function(){var e=mapViewModel.SelectedTrip(),o=mapViewModel.SelectedHarbour(),a=new ClientModel.Tack,i=e.Tacks()[e.Tacks().length-1],t=i.Start();mapViewModel.CalculateDistances(o,t),i.Distance(t.RouteDistance());var n=t;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng);i.End(o),a.Start(o),e.Tacks.push(a)},e.prototype.RedrawTrip=function(){mapViewModel.Map.removeLayer(mapViewModel.routePolyline()),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map);for(var e=0,o=mapViewModel.SelectedTrip().Tacks();e<o.length;e++){var a=o[e],i=a.End(),t=a.Start();if(void 0!==i){mapViewModel.CalculateDistances(i,t),a.Distance(t.RouteDistance());var n=t;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng)}}},e.prototype.PullTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,a=o.indexOf(e),i=o()[a-1],t=e.End();e.End(i.Start()),i.End(t),a>1&&o()[a-2].End(e.Start()),o.splice(a-1,2,e,i),mapViewModel.RedrawTrip()},e.prototype.PushTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,a=o.indexOf(e),i=o()[a+1];e.End(i.End()),i.End(e.Start()),a>0&&o()[a-1].End(i.Start()),o.splice(a,2,i,e),mapViewModel.RedrawTrip()},e.prototype.RemoveTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,a=o.indexOf(e),i=o()[a-1];void 0!==i&&i.End(e.End()),o.remove(e),mapViewModel.RedrawTrip()},e.prototype.LoadData=function(){var e=this;ServerApi.WaypointApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];if(t.Type===ServerModel.Waypoint.GetType())e.Waypoints.push(mapViewModel.CreateWaypoint(L.latLng(t.Latitude,t.Longitude),MarkerType.Waypoint).LoadFromServerEntity(t));else if(t.Type===ServerModel.Harbour.GetType()){var n=mapViewModel.CreateHarbour(t.Name,L.latLng(t.Latitude,t.Longitude)).LoadFromServerEntity(t);e.Harbours.push(n)}}e.WaypointsLoaded=!0,e.InitializeModel()}),ServerApi.WaypointConnectionApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.WaypointConnections.push(t)}e.WaypointConnectionsLoaded=!0,e.InitializeModel()}),ServerApi.PersonApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Persons.push((new ClientModel.Person).LoadFromServerEntity(t))}e.PersonsLoaded=!0,e.InitializeModel()}),ServerApi.JobApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Jobs.push((new ClientModel.Job).LoadFromServerEntity(t))}e.JobsLoaded=!0,e.InitializeModel()}),ServerApi.TripApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Trips.push((new ClientModel.Trip).LoadFromServerEntity(t))}e.TripsLoaded=!0,e.InitializeModel()}),ServerApi.AddressApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Addresses.push((new ClientModel.Address).LoadFromServerEntity(t))}e.AddressesLoaded=!0,e.InitializeModel()}),ServerApi.ImageApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Images.push((new ClientModel.Image).LoadFromServerEntity(t))}e.ImagesLoaded=!0,e.InitializeModel()}),ServerApi.AlbumApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Albums.push((new ClientModel.Album).LoadFromServerEntity(t))}e.AlbumsLoaded=!0,e.InitializeModel()}),ServerApi.AlbumImageApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.AlbumImages.push(t)}e.AlbumImagesLoaded=!0,e.InitializeModel()}),ServerApi.TackApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];e.Tacks.push((new ClientModel.Tack).LoadFromServerEntity(t))}e.TacksLoaded=!0,e.InitializeModel()}),ServerApi.LocationApi.GetDefault().Get().done(function(o){for(var a=0,i=o;a<i.length;a++){var t=i[a];t.Type===ServerModel.Location.GetType()?e.Locations.push((new ClientModel.Location).LoadFromServerEntity(t)):t.Type===ServerModel.Restaurant.GetType()?e.Restaurants.push((new ClientModel.Restaurant).LoadFromServerEntity(t)):t.Type===ServerModel.Supermarket.GetType()&&e.Supermarkets.push((new ClientModel.Supermarket).LoadFromServerEntity(t))}e.LocationsLoaded=!0,e.InitializeModel()})},e.prototype.InitializeModel=function(){if(this.WaypointsLoaded&&this.WaypointConnectionsLoaded&&this.PersonsLoaded&&this.JobsLoaded&&this.TripsLoaded&&this.AddressesLoaded&&this.ImagesLoaded&&this.AlbumsLoaded&&this.TacksLoaded&&this.LocationsLoaded&&this.AlbumImagesLoaded){for(var e=0,o=this.Jobs();e<o.length;e++){var a=o[e];void 0!==a.AssignedToId()&&a.AssignedTo(this.GetPersonById(a.AssignedToId())),void 0!==a.TripId()&&a.Trip(this.GetTripById(a.TripId())),void 0!==a.SuperJobId()&&(a.SuperJob(this.GetJobById(a.SuperJobId())),a.SuperJob().SubJobs.push(a))}for(var i=0,t=this.Harbours();i<t.length;i++){var a=t[i];a.Album(this.GetAlbumById(a.AlbumId()))}for(var n=0,r=this.Locations();n<r.length;n++){var a=r[n];a.Address(this.GetAddressById(a.AddressId())),this.GetHarbourById(a.HarbourId()).Locations.push(a)}for(var d=0,l=this.AlbumImages();d<l.length;d++){var a=l[d];this.GetAlbumById(a.AlbumId).Images.push(this.GetImageById(a.ImageId))}for(var p=0,s=mapViewModel.WaypointConnections();p<s.length;p++){var u=s[p],m=mapViewModel.AddPolyline([mapViewModel.GetWayPointById(u.Waypoint1Id),mapViewModel.GetWayPointById(u.Waypoint2Id)]);addDummyHandle(m)}$("#loadingOverlay").remove()}},e.prototype.InitializeMap=function(){mapViewModel.SelectedHarbour(void 0);for(var e=0,o=mapViewModel.Waypoints();e<o.length;e++){var a=o[e];void 0!==a.marker&&mapViewModel.Map.removeLayer(a.marker),mapViewModel.CreateMarker(MarkerType.Waypoint,a)}for(var i=0,t=mapViewModel.Harbours();i<t.length;i++){var n=t[i];void 0!==n.marker&&mapViewModel.Map.removeLayer(n.marker),mapViewModel.CreateMarker(MarkerType.Harbour,n)}for(var r=0,d=mapViewModel.Polylines;r<d.length;r++){var l=d[r];void 0!==l.DummyHandle.marker&&mapViewModel.Map.removeLayer(l.DummyHandle.marker),mapViewModel.CreateMarker(MarkerType.Dummy,l.DummyHandle)}if(mapViewModel.MapMode()===MapMode.Admin){for(var p=0,s=mapViewModel.Polylines;p<s.length;p++){var l=s[p];l.addTo(mapViewModel.Map)}mapViewModel.Map.contextmenu.enable()}else{for(var u=0,m=mapViewModel.Polylines;u<m.length;u++){var l=m[u];mapViewModel.Map.removeLayer(l)}mapViewModel.Map.contextmenu.disable()}},e.prototype.GetWaypointById=function(e){for(var o=0,a=this.Waypoints();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}for(var t=0,n=this.Harbours();t<n.length;t++){var i=n[t];if(i.Id()===e)return i}},e.prototype.GetHarbourById=function(e){for(var o=0,a=this.Harbours();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetPersonById=function(e){for(var o=0,a=this.Persons();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetJobById=function(e){for(var o=0,a=this.Jobs();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetTripById=function(e){for(var o=0,a=this.Trips();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetAddressById=function(e){for(var o=0,a=this.Addresses();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetImageById=function(e){for(var o=0,a=this.Images();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetTackById=function(e){for(var o=0,a=this.Tacks();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetAlbumById=function(e){for(var o=0,a=this.Albums();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}},e.prototype.GetLocationById=function(e){for(var o=0,a=this.Locations();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}for(var t=0,n=this.Restaurants();t<n.length;t++){var i=n[t];if(i.Id()===e)return i}for(var r=0,d=this.Restaurants();r<d.length;r++){var i=d[r];if(i.Id()===e)return i}},e.prototype.InitGallery=function(){for(var e=new Array,o=this,a=0,i=mapViewModel.SelectedHarbour().Album().Images();a<i.length;a++){var t=i[a];e.push({h:t.Height(),w:t.Width(),src:t.Path()})}gallery=new PhotoSwipe(pswp,PhotoSwipeUI_Default,e,{index:mapViewModel.SelectedHarbour().Album().Images.indexOf(o),getThumbBoundsFn:function(e){var o=$(".images:first img")[e],a=parseFloat(window.getComputedStyle(o,null).getPropertyValue("padding-left").replace("px",""));o.scrollIntoView();var i=o.getBoundingClientRect();return{x:i.left+a,y:i.top+window.screenY+a,w:i.width-2*a}}}),gallery.init()},e.prototype.AddHarbour=function(){var e=mapViewModel.CreateHarbour("Hafen "+this.Harbours.length,this.Map.getCenter());mapViewModel.Harbours.push(e),e.SaveToServer()},e.prototype.AddPolyline=function(e){var o=new L.Polyline([]);if(mapViewModel.Polylines.push(o),mapViewModel.MapMode()===MapMode.Admin&&o.addTo(this.Map),o.Waypoints=new Array,void 0!==e)if(e instanceof Waypoint)e.AddToPolyline(o);else for(var a=0,i=e;a<i.length;a++){var t=i[a];t.AddToPolyline(o)}return o.addEventListener("mouseover",function(){mapViewModel.HoveredPolyine=o}),o},e.prototype.GetMapMode=function(){return void 0!==this.DrawingPolyline&&void 0!==this.DrawingLatLng?MapMode.RouteDrawing:this.MapMode()},e.prototype.GetWayPointById=function(e){for(var o=0,a=this.Waypoints();o<a.length;o++){var i=a[o];if(i.Id()===e)return i}for(var t=0,n=this.Harbours();t<n.length;t++){var i=n[t];if(i.Id()===e)return i}throw"No Waypoint with id "+e+" in model"},e.prototype.CalculateDistances=function(e,o){void 0===e&&(e=mapViewModel.SelectedHarbour());var a=[e],i=new Array,t=new Array,n=void 0!==o;if(i.push(new WaypointDistance(void 0,e,0,a,n)),n){for(var r=0,d=mapViewModel.Waypoints();r<d.length;r++){var l=d[r];l.RoutePrecessor(void 0)}for(var p=0,s=mapViewModel.Harbours();p<s.length;p++){var u=s[p];u.RoutePrecessor(void 0)}}else{for(var m=0,v=mapViewModel.Waypoints();m<v.length;m++){var l=v[m];l.Precessor(void 0)}for(var M=0,y=mapViewModel.Harbours();M<y.length;M++){var u=y[M];u.Precessor(void 0)}}for(;i.length>0;){for(var c=Number.POSITIVE_INFINITY,g=void 0,h=0,w=i;h<w.length;h++){for(var l=w[h],b=0,f=l.ConnectedWayPoints;b<f.length;b++){var L=f[b];void 0!==(n?L.RoutePrecessor():L.Precessor())&&removeFromArray(l.ConnectedWayPoints,L)}if(0===l.ConnectedWayPoints.length)removeFromArray(i,l),t.push(l);else{var V=l.Distance+l.ConnectedWayPoints[0].LatLng.distanceTo(l.LatLng);c>V&&(c=V,g=l)}}void 0!==g&&i.push(new WaypointDistance(g.Waypoint,g.ConnectedWayPoints.shift(),c,a,n))}if(n)for(var D=0,S=t;D<S.length;D++){var l=S[D];l.Waypoint.RouteDistance(Math.round(l.Distance/100)/10)}else for(var k=0,I=t;k<I.length;k++){var l=I[k];l.Waypoint.Distance(Math.round(l.Distance/100)/10)}},e.prototype.ShowRoute=function(e){if(void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.HideRoute()),void 0===e&&(e=this),e instanceof ClientModel.Harbour){var o=[e.LatLng],a=e.Distance();for(void 0===a&&(a=0);void 0!==e.Precessor();)e=e.Precessor(),o.push(e.LatLng);mapViewModel.highlightedRoute=L.polyline(o),mapViewModel.highlightedRoute.addTo(mapViewModel.Map),mapViewModel.highlightedRoute.bindLabel(a.toString()+" km",{noHide:!0}),mapViewModel.FitBounds(mapViewModel.highlightedRoute.getBounds())}},e.prototype.FitBounds=function(e){var o=mapViewModel.Map,a=o.getBounds();a.contains(e)||(void 0===mapViewModel.previousBounds&&(mapViewModel.previousBounds=a),o.fitBounds(e))},e.prototype.HideRoute=function(e){if(void 0===e&&(e=!1),(!mapViewModel.routeFixed||e)&&void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.Map.removeLayer(mapViewModel.highlightedRoute),mapViewModel.highlightedRoute=void 0,!mapViewModel.noRevertToPreviousBounds&&void 0!==mapViewModel.previousBounds)){var o=mapViewModel.previousBounds;mapViewModel.previousBounds=void 0,window.setTimeout(function(){void 0===mapViewModel.previousBounds?mapViewModel.Map.fitBounds(o):mapViewModel.previousBounds=o},100)}},e.prototype.FixRoute=function(){mapViewModel.routeFixed=!0,mapViewModel.previousBounds=void 0},e.prototype.CreateWaypoint=function(e,o){var a=new Waypoint(e,o,mapViewModel.Map);return this.InitializeWaypoint(a,o),a},e.prototype.InitializeWaypoint=function(e,o){this.CreateMarker(o,e)},e.prototype.CreateMarker=function(e,o){if(mapViewModel.MapMode()===MapMode.Admin||e===MarkerType.Harbour){var a={draggable:mapViewModel.MapMode()===MapMode.Admin};e===MarkerType.Dummy&&(a.opacity=0),mapViewModel.MapMode()!==MapMode.Admin||e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(a.icon=new L.Icon({iconUrl:"/images/waypointhandle.png",iconSize:new L.Point(10,10,!0),className:"waypoint"})),mapViewModel.MapMode()===MapMode.Admin&&(a.contextmenu=!0,a.contextmenuInheritItems=!1,e===MarkerType.Harbour?a.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.EditingHarbour(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.DeletingHarbour(this)}}]:a.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.EditingWaypoint(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.DeletingWaypoint(this)}}]);var i=new L.Marker(o.LatLng,a);i.addTo(this.Map),i.Waypoint=o,o.marker=i,mapViewModel.MapMode()===MapMode.Admin?(e===MarkerType.Dummy&&i.addEventListener("mouseout",function(e){e.target.Waypoint.IsDummy()&&(mapViewModel.HoveredPolyine=void 0)}),i.addEventListener("drag",function(e){o.SetLatLng(o.marker.getLatLng())}),e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(this.WaypointMarkers.push(o.marker),o.marker.Point=mapViewModel.Map.latLngToContainerPoint(o.LatLng)),o.marker.addEventListener("click",function(e){o.IsDummy()&&(mapViewModel.Waypoints.push(o),o.convertFromDummyHandle()),mapViewModel.GetMapMode()===MapMode.RouteDrawing&&(o.IsInPolyline(mapViewModel.DrawingPolyline)?(removePolyline(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0):(ServerApi.WaypointConnectionApi.GetDefault().Connect(o.Id(),mapViewModel.DrawingPolyline.Waypoints[0].Id()),o.AddToPolyline(mapViewModel.DrawingPolyline),removeFromPolyline(mapViewModel.DrawingPolyline,mapViewModel.DrawingLatLng),addDummyHandle(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0))}),o.marker.addEventListener("dblclick",function(e){mapViewModel.DrawingPolyline=mapViewModel.AddPolyline(o),mapViewModel.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),mapViewModel.DrawingPolyline.addLatLng(mapViewModel.DrawingLatLng)}),e===MarkerType.Dummy&&o.marker.addOneTimeEventListener("drag",function(e){o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)}),o.marker.addEventListener("dragend",function(e){o.SaveToServer()})):e===MarkerType.Harbour&&(o.marker.addEventListener("mouseover",function(){void 0!==mapViewModel.SelectedHarbour()&&mapViewModel.ShowRoute(o)}),o.marker.addEventListener("click",function(){return mapViewModel.SelectedHarbour(o)}))}},e.prototype.CreateHarbour=function(e,o){var a=new Harbour(e,o,this.Map);return this.InitializeWaypoint(a,MarkerType.Harbour),a},e.prototype.SaveHarbour=function(){var e=this;void 0===e.Id()&&mapViewModel.Harbours.push(e),e.SaveToServer().done(function(){mapViewModel.EditingHarbour(void 0)})},e.prototype.DeleteHarbour=function(){var e=mapViewModel.DeletingHarbour();ServerApi.WaypointConnectionApi.GetDefault().Disconnect(e.Id()).done(function(){e.DeleteOnServer().done(function(){e.RemoveFromMap(),mapViewModel.Harbours.remove(e),mapViewModel.DeletingHarbour(void 0)})})},e.prototype.SaveWaypoint=function(){var e=this;e.SaveToServer().done(function(){mapViewModel.EditingWaypoint(void 0)})},e.prototype.DeleteWaypoint=function(){var e=mapViewModel.DeletingWaypoint();ServerApi.WaypointConnectionApi.GetDefault().Disconnect(e.Id()).done(function(){e.DeleteOnServer().done(function(){e.RemoveFromMap(),mapViewModel.Waypoints.remove(e),mapViewModel.DeletingWaypoint(void 0)})})},e.prototype.SaveJob=function(){var e=this,o=void 0===e.Id();e.SaveToServer().done(function(){o&&(mapViewModel.Jobs.push(mapViewModel.EditingJob()),void 0!==mapViewModel.EditingJob().SuperJobId()&&mapViewModel.GetJobById(mapViewModel.EditingJob().SuperJobId()).SubJobs.push(mapViewModel.EditingJob())),mapViewModel.EditingJob(void 0)})},e.prototype.DeleteJob=function(){var e=mapViewModel.DeletingJob();e.DeleteOnServer().done(function(){mapViewModel.Jobs.remove(e),void 0!==e.SuperJobId()&&mapViewModel.GetJobById(e.SuperJobId()).SubJobs.remove(e),mapViewModel.DeletingJob(void 0)})},e}(),mapViewModel=new MapViewModel(MapMode.View);ko.applyBindings(mapViewModel);var dropzoneModalOpenedByDrag=!1,dropzoneModal=$("#dropzoneModal"),editingHarbourModal=$("#editingHarbourModal"),deletingHarbourModal=$("#deletingHarbourModal"),editingWaypointModal=$("#editingWaypointModal"),deletingWaypointModal=$("#deletingWaypointModal"),deletingJobModal=$("#deletingJobModal"),editingJobModal=$("#editingJobModal"),jobOverviewModal=$("#jobOverviewModal"),dropzone,hasDrag=!1,uploadModalVisible=!1,pswp=$(".pswp")[0],leftSidebar=new Sidebar($("#leftSidebar")),rightSidebar=new Sidebar($("#rightSidebar")),bottomSidebar=new Sidebar($("#bottomSidebar")),harbourInfo=$("#harbourInfo");Dropzone.options.dropzone={acceptedFiles:"image/jpeg,image/png",dictInvalidFileType:"Dieser Dateityp wird nicht unterstützt",dictDefaultMessage:"Dateien hier ablegen",init:function(){dropzone=this,dropzone.on("success",function(e,o){var a=(new ClientModel.Image).LoadFromServerEntity(o);mapViewModel.Images.push(a),mapViewModel.GetAlbumById(a.ParentAlbumId()).Images.push(a)}),dropzone.on("queuecomplete",function(){dropzoneModalOpenedByDrag&&dropzoneModal.modal("hide")}),dropzone.on("dragover",function(){hasDrag=!0})}},document.ondragenter=function(e){uploadModalVisible||hasDrag||dropzoneModalOpenedByDrag||!dropzoneModal.is(":not(.in)")||"Files"!==e.dataTransfer.types[0]||void 0===mapViewModel.SelectedHarbour()||(dropzoneModal.modal("show"),uploadModalVisible=!0,dropzoneModalOpenedByDrag=!0),hasDrag=!0,e.preventDefault(),e.stopPropagation()},document.ondragover=function(e){hasDrag=!0},document.ondragleave=function(e){(uploadModalVisible&&hasDrag&&dropzoneModalOpenedByDrag&&0===dropzone.getQueuedFiles().length||0===dropzone.getUploadingFiles().length)&&(hasDrag=!1,window.setTimeout(function(){hasDrag||(dropzoneModal.modal("hide"),uploadModalVisible=!1)},1e3)),e.preventDefault(),e.stopPropagation()},dropzoneModal.on("hide.bs.modal",function(e){return dropzone.getQueuedFiles().length>0||dropzone.getUploadingFiles().length>0?(e.preventDefault(),e.stopImmediatePropagation(),alert("Das Fenster kann nicht geschlossen werden, während Dateien hochgeladen werden."),!1):(dropzone.removeAllFiles(),void(dropzoneModalOpenedByDrag=!1))});var gallery;$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(e){"undefined"==typeof $("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))});
//# sourceMappingURL=Map.min.js.map
