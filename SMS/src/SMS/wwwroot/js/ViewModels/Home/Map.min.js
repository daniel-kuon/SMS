function renderTime(e,o){if(e instanceof Date)return renderTime(o.getTime()-e.getTime());var i=e,a=Math.ceil(i/6e4),t=(a%60).toString();return 1===t.length&&(t="0"+t),a=Math.ceil(a/60),a.toString()+":"+t}function getMiddle(e){var o=e.getLatLngs()[0],i=e.getLatLngs()[1];return new L.LatLng(o.lat+(i.lat-o.lat)/2,o.lng+(i.lng-o.lng)/2)}function splitPolyline(e){if(2===e.Waypoints.length&&e.DummyHandle instanceof Waypoint){var o=(e.Waypoints[0],e.DummyHandle),i=e.Waypoints[1];return o.RemoveFromPolyline(e),e.DummyHandle=void 0,o.AddToPolyline(e),i.RemoveFromPolyline(e),addDummyHandle(e),void addDummyHandle(mapViewModel.AddPolyline([o,i]))}throw new Error("Cannot split polyline. Polyline has no dummy handle or less or more than 2 waypoints")}function removePolyline(e){for(var o=0,i=e.Waypoints;o<i.length;o++){var a=i[o];a.RemoveFromPolyline(e)}void 0!==e.DummyHandle&&(e.DummyHandle.RemoveFromPolyline(e),e.DummyHandle.RemoveFromMap()),mapViewModel.Map.removeLayer(e)}function addDummyHandle(e){void 0===e.DummyHandle&&(e.DummyHandle=mapViewModel.CreateWaypoint(getMiddle(e),MarkerType.Dummy),e.DummyHandle.AddToPolyline(e))}function redrawPolyline(e){var o=getMiddle(e);void 0===e.DummyHandle&&addDummyHandle(e),e.DummyHandle.Longitude()!==o.lng||e.DummyHandle.Latitude()!==o.lat?e.DummyHandle.SetLatLng(o):e.redraw()}function removeFromPolyline(e,o){removeFromArray(e.getLatLngs(),o),e.redraw()}function removeFromArray(e,o){for(var i=new Array,a=0,t=e;a<t.length;a++){var n=t[a];n!==o&&i.push(n)}if(i.length===e.length)return!1;for(;e.pop(););for(;i.length>0;)e.push(i.shift());return!0}var Waypoint=ClientModel.Waypoint,Harbour=ClientModel.Harbour,Job=ClientModel.Job,WaypointDistance=ClientModel.WaypointDistance;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("body").addClass("mobile");var MapMode;!function(e){e[e.Admin=0]="Admin",e[e.View=1]="View",e[e.TripPlanning=2]="TripPlanning",e[e.RouteDrawing=3]="RouteDrawing"}(MapMode||(MapMode={}));var MapViewModel=function(){function e(e){var o=this;this.routePolyline=ko.observable(),this.IsLastTakInRoute=ko.computed({read:function(){var e=mapViewModel.SelectedTrip(),o=mapViewModel.SelectedHarbour();return void 0!==e&&void 0!==o&&e.Tacks()[e.Tacks().length-1].Start()===o},deferEvaluation:!0}),this.GetRouteDistance=ko.computed({read:function(){for(var e=0,o=0,i=mapViewModel.SelectedTrip().Tacks();o<i.length;o++){var a=i[o];isNaN(a.Distance())||(e+=a.Distance())}return e},deferEvaluation:!0}),this.TopJobs=ko.computed({read:function(){return mapViewModel.Jobs().filter(function(e){return void 0===e.SuperJobId()})},deferEvaluation:!0}),this.IsInViewMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.View},deferEvaluation:!0}),this.IsInAdminMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.Admin},deferEvaluation:!0}),this.WaypointsLoaded=!1,this.WaypointConnectionsLoaded=!1,this.PersonsLoaded=!1,this.JobsLoaded=!1,this.TripsLoaded=!1,this.AddressesLoaded=!1,this.ImagesLoaded=!1,this.AlbumsLoaded=!1,this.WaypointTacksLoaded=!1,this.TacksLoaded=!1,this.LocationsLoaded=!1,this.AlbumImagesLoaded=!1,this.LogBookEntriesLoaded=!1,this.CrewsLoaded=!1,this.Waypoints=ko.observableArray(),this.WaypointConnections=ko.observableArray(),this.Harbours=ko.observableArray(),this.Persons=ko.observableArray(),this.Jobs=ko.observableArray(),this.Trips=ko.observableArray(),this.Addresses=ko.observableArray(),this.Images=ko.observableArray(),this.Tacks=ko.observableArray(),this.Locations=ko.observableArray(),this.Supermarkets=ko.observableArray(),this.Restaurants=ko.observableArray(),this.Albums=ko.observableArray(),this.AlbumImages=ko.observableArray(),this.LogBookEntries=ko.observableArray(),this.Crews=ko.observableArray(),this.SelectedWaypoint=ko.observable(),this.SelectedHarbour=ko.observable(),this.SelectedPerson=ko.observable(),this.SelectedJob=ko.observable(),this.SelectedTrip=ko.observable(),this.SelectedAddress=ko.observable(),this.SelectedImage=ko.observable(),this.SelectedTack=ko.observable(),this.SelectedLocation=ko.observable(),this.SelectedSupermarket=ko.observable(),this.SelectedRestaurant=ko.observable(),this.SelectedLogBookEntry=ko.observable(),this.RemoveHarbour=function(){mapViewModel.SelectedWaypoint().RemoveFromMap(),mapViewModel.Waypoints.remove(o.SelectedWaypoint())},this.RemoveWaypoint=function(){mapViewModel.SelectedHarbour().RemoveFromMap(),mapViewModel.Harbours.remove(o.SelectedHarbour()),mapViewModel.Harbours.remove(o.SelectedHarbour())},this.MapMode=ko.observable(),this.RemovePolyline=function(e){o.Map.removeLayer(e),o.DrawingPolyline=void 0},this.routeFixed=!1,this.noRevertToPreviousBounds=!1,this.Polylines=new Array,this.DeletingPerson=ko.observable(),this.EditingPerson=ko.observable(),this.EditingHarbour=ko.observable(),this.DeletingHarbour=ko.observable(),this.EditingWaypoint=ko.observable(),this.DeletingWaypoint=ko.observable(),this.DeletingJob=ko.observable(),this.EditingJob=ko.observable(),this.EditingLogBookEntry=ko.observable(),this.DeletingLogBookEntry=ko.observable(),this.DetailedLogBookEntry=ko.observable(),this.WaypointMarkers=new Array,L.mapbox.accessToken="pk.eyJ1IjoiZGFuaWVsLWt1b24iLCJhIjoiY2lldnVtY29iMDBiOHQxbTBvZzBqZWl6cCJ9.UEc2YqH59pB1YTpv22vg8A",this.MapMode(e),this.MapMode.subscribe(function(){o.InitializeMap()});var i={contextmenu:e===MapMode.Admin,contextmenuItems:[{text:"Neuer Hafen",callback:function(e){console.log(e),mapViewModel.EditingHarbour(mapViewModel.CreateHarbour("",e.latlng))}}]};this.Map=L.mapbox.map("map","mapbox.streets",i),this.Map.setView([54.40774166820069,10.523529052734373],9),L.tileLayer("http://t1.openseamap.org/seamark/{z}/{x}/{y}.png").addTo(this.Map),this.LoadData(),this.SelectedHarbour.subscribe(function(e){if(void 0!==e)mapViewModel.CalculateDistances(e),mapViewModel.Harbours.sort(function(e,o){return e.Distance()-o.Distance()});else for(var o=0,i=mapViewModel.Harbours();o<i.length;o++){var a=i[o];a.Distance(0)}mapViewModel.routeFixed=!1,mapViewModel.HideRoute()}),this.EditingHarbour.subscribe(function(e){void 0===e?editingHarbourModal.modal("hide"):(e.SaveState(),editingHarbourModal.modal("show"))}),this.EditingHarbour.subscribe(function(e){void 0!==e&&(e.RevertState(!0),void 0===e.Id()&&mapViewModel.Map.removeLayer(e.marker))},this,"beforeChange"),this.DeletingHarbour.subscribe(function(e){void 0===e?deletingHarbourModal.modal("hide"):deletingHarbourModal.modal("show")}),this.EditingWaypoint.subscribe(function(e){void 0===e?editingWaypointModal.modal("hide"):(e.SaveState(),editingWaypointModal.modal("show"))}),this.EditingWaypoint.subscribe(function(e){void 0!==mapViewModel.EditingWaypoint()&&mapViewModel.EditingWaypoint().RevertState(!0)},this,"beforeChange"),this.DeletingWaypoint.subscribe(function(e){void 0===e?deletingWaypointModal.modal("hide"):deletingWaypointModal.modal("show")}),this.EditingJob.subscribe(function(e){void 0===e?editingJobModal.modal("hide"):(e.SaveState(),editingJobModal.modal("show"))}),this.EditingJob.subscribe(function(e){void 0!==mapViewModel.EditingJob()&&mapViewModel.EditingJob().RevertState(!0)},this,"beforeChange"),this.DeletingJob.subscribe(function(e){void 0===e?deletingJobModal.modal("hide"):deletingJobModal.modal("show")}),this.EditingPerson.subscribe(function(e){void 0===e?editingPersonModal.modal("hide"):(e.SaveState(),editingPersonModal.modal("show"))}),this.EditingPerson.subscribe(function(e){void 0!==mapViewModel.EditingPerson()&&mapViewModel.EditingPerson().RevertState(!0)},this,"beforeChange"),this.DeletingPerson.subscribe(function(e){void 0===e?deletingPersonModal.modal("hide"):deletingPersonModal.modal("show")}),this.DetailedLogBookEntry.subscribe(function(e){detailedLogBookEntryModal.modal("show")}),this.EditingLogBookEntry.subscribe(function(e){void 0===e?editingLogBookEntryModal.modal("hide"):(e.SaveState(),editingLogBookEntryModal.modal("show"))}),this.EditingLogBookEntry.subscribe(function(e){void 0!==mapViewModel.EditingLogBookEntry()&&mapViewModel.EditingLogBookEntry().RevertState(!0)},this,"beforeChange"),this.SelectedHarbour.subscribe(function(e){void 0===e?rightSidebar.Hide():rightSidebar.Show()}),this.SelectedTrip.subscribe(function(e){void 0===e?bottomSidebar.Hide():bottomSidebar.Show()}),this.Map.addEventListener("mousemove",function(e){if(o.GetMapMode()===MapMode.RouteDrawing&&(o.DrawingLatLng.lat=e.latlng.lat,o.DrawingLatLng.lng=e.latlng.lng,o.DrawingPolyline.redraw()),o.MapMode()===MapMode.Admin)for(var i=0,a=o.WaypointMarkers;i<a.length;i++){var t=a[i];t.Point.distanceTo(e.containerPoint)<150?t.setOpacity(t.Waypoint.IsDummy()?0:1):t.setOpacity(t.Waypoint.IsDummy()?0:.8)}if(void 0!==mapViewModel.HoveredPolyine&&void 0!==mapViewModel.HoveredPolyine.DummyHandle){var n=mapViewModel.HoveredPolyine,r=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[0]),d=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[1]);r.distanceTo(e.containerPoint)<20||d.distanceTo(e.containerPoint)<20?mapViewModel.HoveredPolyine=void 0:(mapViewModel.HoveredPolyine.DummyHandle.marker.setOpacity(.8),mapViewModel.HoveredPolyine.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,r,d)),!1))}}),this.Map.addEventListener("click",function(e){if(o.GetMapMode()===MapMode.RouteDrawing){var i=mapViewModel.CreateWaypoint(e.latlng,MarkerType.Waypoint),a=o.DrawingPolyline.Waypoints[0].Id();i.SaveToServer().done(function(e){ServerApi.WaypointConnections.Connect(e.Id,a)}),i.AddToPolyline(o.DrawingPolyline),addDummyHandle(o.DrawingPolyline),removeFromPolyline(o.DrawingPolyline,o.DrawingLatLng),o.DrawingPolyline=o.AddPolyline(i),o.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),o.DrawingPolyline.addLatLng(o.DrawingLatLng)}}),this.Map.addEventListener("dblclick",function(e){o.GetMapMode()===MapMode.RouteDrawing&&(e.originalEvent.cancelBubble=!0,e.originalEvent.preventDefault(),e.originalEvent.stopPropagation(),o.DrawingPolyline.addLatLng(e.latlng),o.DrawingLatLng=e.latlng)}),$(document).keyup(function(e){o.GetMapMode()===MapMode.RouteDrawing&&27===e.keyCode&&o.RemovePolyline(o.DrawingPolyline)}),this.Map.addEventListener("move",function(e){for(var i=0,a=o.WaypointMarkers;i<a.length;i++){var t=a[i];t.Point=o.Map.latLngToContainerPoint(t.getLatLng())}}),this.Map.addEventListener("zoom",function(e){for(var i=0,a=o.WaypointMarkers;i<a.length;i++){var t=a[i];t.Point=o.Map.latLngToContainerPoint(t.getLatLng())}})}return e.prototype.StartRoute=function(){var e=new ClientModel.Trip,o=new ClientModel.Tack,i=mapViewModel.SelectedHarbour();o.Start(i),e.Tacks.push(o),mapViewModel.SelectedTrip(e),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map)},e.prototype.AddToRoute=function(){var e=mapViewModel.SelectedTrip(),o=mapViewModel.SelectedHarbour(),i=new ClientModel.Tack,a=e.Tacks()[e.Tacks().length-1],t=a.Start();mapViewModel.CalculateDistances(o,t),a.Distance(t.RouteDistance());var n=t;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng);a.End(o),i.Start(o),e.Tacks.push(i)},e.prototype.RedrawTrip=function(){mapViewModel.Map.removeLayer(mapViewModel.routePolyline()),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map);for(var e=0,o=mapViewModel.SelectedTrip().Tacks();e<o.length;e++){var i=o[e],a=i.End(),t=i.Start();if(void 0!==a){mapViewModel.CalculateDistances(a,t),i.Distance(t.RouteDistance());var n=t;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng)}}},e.prototype.PullTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,i=o.indexOf(e),a=o()[i-1],t=e.End();e.End(a.Start()),a.End(t),i>1&&o()[i-2].End(e.Start()),o.splice(i-1,2,e,a),mapViewModel.RedrawTrip()},e.prototype.PushTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,i=o.indexOf(e),a=o()[i+1];e.End(a.End()),a.End(e.Start()),i>0&&o()[i-1].End(a.Start()),o.splice(i,2,a,e),mapViewModel.RedrawTrip()},e.prototype.RemoveTack=function(){var e=this,o=mapViewModel.SelectedTrip().Tacks,i=o.indexOf(e),a=o()[i-1];void 0!==a&&a.End(e.End()),o.remove(e),mapViewModel.RedrawTrip()},e.prototype.LoadData=function(){var e=this;ServerApi.Waypoints.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];if("Waypoint"===t.Type)e.Waypoints.push(mapViewModel.CreateWaypoint(MarkerType.Waypoint).LoadFromServerEntity(t));else if("Harbour"===t.Type){var n=mapViewModel.CreateHarbour().LoadFromServerEntity(t);e.Harbours.push(n)}}e.WaypointsLoaded=!0,e.InitializeModel()}),ServerApi.WaypointConnections.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.WaypointConnections.push(t)}e.WaypointConnectionsLoaded=!0,e.InitializeModel()}),ServerApi.Persons.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Persons.push((new ClientModel.Person).LoadFromServerEntity(t))}e.PersonsLoaded=!0,e.InitializeModel()}),ServerApi.Jobs.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Jobs.push((new ClientModel.Job).LoadFromServerEntity(t))}e.JobsLoaded=!0,e.InitializeModel()}),ServerApi.Trips.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Trips.push((new ClientModel.Trip).LoadFromServerEntity(t))}e.TripsLoaded=!0,e.InitializeModel()}),ServerApi.Addresses.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Addresses.push((new ClientModel.Address).LoadFromServerEntity(t))}e.AddressesLoaded=!0,e.InitializeModel()}),ServerApi.Images.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Images.push((new ClientModel.Image).LoadFromServerEntity(t))}e.ImagesLoaded=!0,e.InitializeModel()}),ServerApi.Albums.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Albums.push((new ClientModel.Album).LoadFromServerEntity(t))}e.AlbumsLoaded=!0,e.InitializeModel()}),ServerApi.LogBookEntries.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.LogBookEntries.push((new ClientModel.LogBookEntry).LoadFromServerEntity(t))}e.LogBookEntriesLoaded=!0,e.InitializeModel()}),ServerApi.AlbumImages.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.AlbumImages.push(t)}e.AlbumImagesLoaded=!0,e.InitializeModel()}),ServerApi.Crews.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Crews.push(t)}e.CrewsLoaded=!0,e.InitializeModel()}),ServerApi.Tacks.Get().done(function(o){for(var i=0,a=o;i<a.length;i++){var t=a[i];e.Tacks.push((new ClientModel.Tack).LoadFromServerEntity(t))}e.TacksLoaded=!0,e.InitializeModel()}),this.LocationsLoaded=!0},e.prototype.InitializeModel=function(){if(this.WaypointsLoaded&&this.WaypointConnectionsLoaded&&this.PersonsLoaded&&this.JobsLoaded&&this.TripsLoaded&&this.AddressesLoaded&&this.ImagesLoaded&&this.AlbumsLoaded&&this.TacksLoaded&&this.LocationsLoaded&&this.CrewsLoaded&&this.AlbumImagesLoaded){for(var e=0,o=this.Jobs();e<o.length;e++){var i=o[e];void 0!==i.AssignedToId()&&i.AssignedTo(this.GetPersonById(i.AssignedToId())),void 0!==i.TripId()&&i.Trip(this.GetTripById(i.TripId())),void 0!==i.SuperJobId()&&(i.SuperJob(this.GetJobById(i.SuperJobId())),i.SuperJob().SubJobs.push(i))}for(var a=0,t=this.Harbours();a<t.length;a++){var i=t[a];i.Album(this.GetAlbumById(i.AlbumId()))}for(var n=0,r=this.Locations();n<r.length;n++){var i=r[n];i.Address(this.GetAddressById(i.AddressId())),this.GetHarbourById(i.HarbourId()).Locations.push(i)}for(var d=0,l=this.AlbumImages();d<l.length;d++){var i=l[d];this.GetAlbumById(i.AlbumId).Images.push(this.GetImageById(i.ImageId))}for(var s=0,p=mapViewModel.WaypointConnections();s<p.length;s++){var m=p[s],u=mapViewModel.AddPolyline([mapViewModel.GetWayPointById(m.Waypoint1Id),mapViewModel.GetWayPointById(m.Waypoint2Id)]);addDummyHandle(u)}for(var v=0,M=mapViewModel.LogBookEntries();v<M.length;v++){var g=M[v];g.Start(mapViewModel.GetHarbourById(g.StartId())),g.End(mapViewModel.GetHarbourById(g.EndId())),g.Album(mapViewModel.GetAlbumById(g.AlbumId()))}for(var y=0,c=mapViewModel.Crews();y<c.length;y++){var h=c[y],w=mapViewModel.GetLogBookEntryById(h.TackId),b=mapViewModel.GetTackById(h.TackId),f=mapViewModel.GetTripById(h.TackId),L=mapViewModel.GetPersonById(h.PersonId);void 0!==w?w.Persons.push(L):void 0!==b?b.Persons.push(L):void 0!==f&&f.Persons.push(L)}ko.applyBindings(mapViewModel),$("#loadingOverlay").remove()}},e.prototype.InitializeMap=function(){mapViewModel.SelectedHarbour(void 0);for(var e=0,o=mapViewModel.Waypoints();e<o.length;e++){var i=o[e];void 0!==i.marker&&mapViewModel.Map.removeLayer(i.marker),mapViewModel.CreateMarker(MarkerType.Waypoint,i)}for(var a=0,t=mapViewModel.Harbours();a<t.length;a++){var n=t[a];void 0!==n.marker&&mapViewModel.Map.removeLayer(n.marker),mapViewModel.CreateMarker(MarkerType.Harbour,n)}for(var r=0,d=mapViewModel.Polylines;r<d.length;r++){var l=d[r];void 0!==l.DummyHandle.marker&&mapViewModel.Map.removeLayer(l.DummyHandle.marker),mapViewModel.CreateMarker(MarkerType.Dummy,l.DummyHandle)}if(mapViewModel.MapMode()===MapMode.Admin){for(var s=0,p=mapViewModel.Polylines;s<p.length;s++){var l=p[s];l.addTo(mapViewModel.Map)}mapViewModel.Map.contextmenu.enable()}else{for(var m=0,u=mapViewModel.Polylines;m<u.length;m++){var l=u[m];mapViewModel.Map.removeLayer(l)}mapViewModel.Map.contextmenu.disable()}},e.prototype.GetWaypointById=function(e){for(var o=0,i=this.Waypoints();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}for(var t=0,n=this.Harbours();t<n.length;t++){var a=n[t];if(a.Id()===e)return a}},e.prototype.GetHarbourById=function(e){for(var o=0,i=this.Harbours();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetPersonById=function(e){for(var o=0,i=this.Persons();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetJobById=function(e){for(var o=0,i=this.Jobs();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetTripById=function(e){for(var o=0,i=this.Trips();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetAddressById=function(e){for(var o=0,i=this.Addresses();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetImageById=function(e){for(var o=0,i=this.Images();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetTackById=function(e){for(var o=0,i=this.Tacks();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetLogBookEntryById=function(e){for(var o=0,i=this.LogBookEntries();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetAlbumById=function(e){for(var o=0,i=this.Albums();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}},e.prototype.GetLocationById=function(e){for(var o=0,i=this.Locations();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}for(var t=0,n=this.Restaurants();t<n.length;t++){var a=n[t];if(a.Id()===e)return a}for(var r=0,d=this.Restaurants();r<d.length;r++){var a=d[r];if(a.Id()===e)return a}},e.prototype.InitGallery=function(){for(var e=new Array,o=this,i=0,a=mapViewModel.SelectedHarbour().Album().Images();i<a.length;i++){var t=a[i];e.push({h:t.Height(),w:t.Width(),src:t.Path()})}gallery=new PhotoSwipe(pswp,PhotoSwipeUI_Default,e,{index:mapViewModel.SelectedHarbour().Album().Images.indexOf(o),getThumbBoundsFn:function(e){var o=$(".images:first img")[e],i=parseFloat(window.getComputedStyle(o,null).getPropertyValue("padding-left").replace("px",""));o.scrollIntoView(!1);var a=o.getBoundingClientRect();return{x:a.left+i,y:a.top+window.screenY+i,w:a.width-2*i}}}),gallery.init()},e.prototype.AddHarbour=function(){var e=mapViewModel.CreateHarbour("Hafen "+this.Harbours.length,this.Map.getCenter());mapViewModel.Harbours.push(e),e.SaveToServer()},e.prototype.AddPolyline=function(e){var o=new L.Polyline([]);if(mapViewModel.Polylines.push(o),o.addEventListener("click",function(e){var i=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[0]),a=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[1]);o.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,i,a)),!1),mapViewModel.Waypoints.push(o.DummyHandle),o.DummyHandle.convertFromDummyHandle()}),mapViewModel.MapMode()===MapMode.Admin&&o.addTo(this.Map),o.Waypoints=new Array,void 0!==e)if(e instanceof Waypoint)e.AddToPolyline(o);else for(var i=0,a=e;i<a.length;i++){var t=a[i];t.AddToPolyline(o)}return o.addEventListener("mouseover",function(){}),o},e.prototype.GetMapMode=function(){return void 0!==this.DrawingPolyline&&void 0!==this.DrawingLatLng?MapMode.RouteDrawing:this.MapMode()},e.prototype.GetWayPointById=function(e){for(var o=0,i=this.Waypoints();o<i.length;o++){var a=i[o];if(a.Id()===e)return a}for(var t=0,n=this.Harbours();t<n.length;t++){var a=n[t];if(a.Id()===e)return a}throw"No Waypoint with id "+e+" in model"},e.prototype.CalculateDistances=function(e,o){void 0===e&&(e=mapViewModel.SelectedHarbour());var i=[e],a=new Array,t=new Array,n=void 0!==o;if(a.push(new WaypointDistance(void 0,e,0,i,n)),n){for(var r=0,d=mapViewModel.Waypoints();r<d.length;r++){var l=d[r];l.RoutePrecessor(void 0)}for(var s=0,p=mapViewModel.Harbours();s<p.length;s++){var m=p[s];m.RoutePrecessor(void 0)}}else{for(var u=0,v=mapViewModel.Waypoints();u<v.length;u++){var l=v[u];l.Precessor(void 0)}for(var M=0,g=mapViewModel.Harbours();M<g.length;M++){var m=g[M];m.Precessor(void 0)}}for(;a.length>0;){for(var y=Number.POSITIVE_INFINITY,c=void 0,h=0,w=a;h<w.length;h++){for(var l=w[h],b=0,f=l.ConnectedWayPoints;b<f.length;b++){var L=f[b];void 0!==(n?L.RoutePrecessor():L.Precessor())&&removeFromArray(l.ConnectedWayPoints,L)}if(0===l.ConnectedWayPoints.length)removeFromArray(a,l),t.push(l);else{var V=l.Distance+l.ConnectedWayPoints[0].LatLng.distanceTo(l.LatLng)/1.852;y>V&&(y=V,c=l)}}void 0!==c&&a.push(new WaypointDistance(c.Waypoint,c.ConnectedWayPoints.shift(),y,i,n))}if(n)for(var k=0,D=t;k<D.length;k++){var l=D[k];l.Waypoint.RouteDistance(Math.round(l.Distance/100)/10)}else for(var P=0,S=t;P<S.length;P++){var l=S[P];l.Waypoint.Distance(Math.round(l.Distance/100)/10)}},e.prototype.ShowRoute=function(e){if(void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.HideRoute()),void 0===e&&(e=this),e instanceof ClientModel.Harbour){var o=[e.LatLng],i=e.Distance();for(void 0===i&&(i=0);void 0!==e.Precessor();)e=e.Precessor(),o.push(e.LatLng);mapViewModel.highlightedRoute=L.polyline(o),mapViewModel.highlightedRoute.addTo(mapViewModel.Map),mapViewModel.highlightedRoute.bindLabel(i.toString()+" sm",{noHide:!0}),mapViewModel.FitBounds(mapViewModel.highlightedRoute.getBounds())}},e.prototype.FitBounds=function(e){var o=mapViewModel.Map,i=o.getBounds();i.contains(e)||(void 0===mapViewModel.previousBounds&&(mapViewModel.previousBounds=i),o.fitBounds(e))},e.prototype.HideRoute=function(e){if(void 0===e&&(e=!1),(!mapViewModel.routeFixed||e)&&void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.Map.removeLayer(mapViewModel.highlightedRoute),mapViewModel.highlightedRoute=void 0,!mapViewModel.noRevertToPreviousBounds&&void 0!==mapViewModel.previousBounds)){var o=mapViewModel.previousBounds;mapViewModel.previousBounds=void 0,window.setTimeout(function(){void 0===mapViewModel.previousBounds?mapViewModel.Map.fitBounds(o):mapViewModel.previousBounds=o},100)}},e.prototype.FixRoute=function(){mapViewModel.routeFixed=!0,mapViewModel.previousBounds=void 0},e.prototype.CreateWaypoint=function(e,o){var i;return i=void 0!==o?new Waypoint(e,o,mapViewModel.Map):new Waypoint(o,mapViewModel.Map),this.InitializeWaypoint(i,o),i},e.prototype.InitializeWaypoint=function(e,o){this.CreateMarker(o,e)},e.prototype.CreateMarker=function(e,o){if(mapViewModel.MapMode()===MapMode.Admin||e===MarkerType.Harbour){var i={draggable:mapViewModel.MapMode()===MapMode.Admin};e===MarkerType.Dummy&&(i.opacity=0),mapViewModel.MapMode()!==MapMode.Admin||e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(i.icon=new L.Icon({iconUrl:"/images/waypointhandle.png",iconSize:new L.Point(10,10,!0),className:"waypoint"})),mapViewModel.MapMode()===MapMode.Admin&&(i.contextmenu=!0,i.contextmenuInheritItems=!1,e===MarkerType.Harbour?i.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.EditingHarbour(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.DeletingHarbour(this)}}]:i.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.EditingWaypoint(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.DeletingWaypoint(this)}}]);var a=new L.Marker(o.LatLng,i);a.addTo(this.Map),a.Waypoint=o,o.marker=a,mapViewModel.MapMode()===MapMode.Admin?(e===MarkerType.Dummy&&a.addEventListener("mouseout",function(e){e.target.Waypoint.IsDummy()&&(mapViewModel.HoveredPolyine=void 0)}),a.addEventListener("drag",function(e){o.SetLatLng(o.marker.getLatLng())}),e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(this.WaypointMarkers.push(o.marker),o.marker.Point=mapViewModel.Map.latLngToContainerPoint(o.LatLng)),o.marker.addEventListener("click",function(e){o.IsDummy()&&(mapViewModel.Waypoints.push(o),o.convertFromDummyHandle()),mapViewModel.GetMapMode()===MapMode.RouteDrawing&&(o.IsInPolyline(mapViewModel.DrawingPolyline)?(removePolyline(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0):(ServerApi.WaypointConnections.Connect(o.Id(),mapViewModel.DrawingPolyline.Waypoints[0].Id()),o.AddToPolyline(mapViewModel.DrawingPolyline),removeFromPolyline(mapViewModel.DrawingPolyline,mapViewModel.DrawingLatLng),addDummyHandle(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0))}),o.marker.addEventListener("dblclick",function(e){mapViewModel.DrawingPolyline=mapViewModel.AddPolyline(o),mapViewModel.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),mapViewModel.DrawingPolyline.addLatLng(mapViewModel.DrawingLatLng)}),e===MarkerType.Dummy&&o.marker.addOneTimeEventListener("drag",function(e){o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)}),o.marker.addEventListener("dragend",function(e){o.SaveToServer()})):e===MarkerType.Harbour&&(o.marker.addEventListener("mouseover",function(){void 0!==mapViewModel.SelectedHarbour()&&mapViewModel.ShowRoute(o)}),o.marker.addEventListener("click",function(){return mapViewModel.SelectedHarbour(o)}))}},e.prototype.CreateHarbour=function(e,o){var i;return i=void 0!==o?new Harbour(o,this.Map):new Harbour(this.Map),i.Name(e),this.InitializeWaypoint(i,MarkerType.Harbour),i},e.prototype.SaveHarbour=function(){var e=this;void 0===e.Id()&&mapViewModel.Harbours.push(e),e.SaveToServer().done(function(){mapViewModel.EditingHarbour(void 0)})},e.prototype.DeleteHarbour=function(){var e=mapViewModel.DeletingHarbour();ServerApi.WaypointConnections.Disconnect(e.Id()).done(function(){e.DeleteOnServer().done(function(){e.RemoveFromMap(),mapViewModel.Harbours.remove(e),mapViewModel.DeletingHarbour(void 0)})})},e.prototype.SaveWaypoint=function(){var e=this;e.SaveToServer().done(function(){mapViewModel.EditingWaypoint(void 0)})},e.prototype.DeleteWaypoint=function(){var e=mapViewModel.DeletingWaypoint();ServerApi.WaypointConnections.Disconnect(e.Id()).done(function(){e.DeleteOnServer().done(function(){e.RemoveFromMap(),mapViewModel.Waypoints.remove(e),mapViewModel.DeletingWaypoint(void 0)})})},e.prototype.SaveJob=function(){var e=this,o=void 0===e.Id();e.SaveToServer().done(function(){o&&(mapViewModel.Jobs.push(mapViewModel.EditingJob()),void 0!==mapViewModel.EditingJob().SuperJobId()&&mapViewModel.GetJobById(mapViewModel.EditingJob().SuperJobId()).SubJobs.push(mapViewModel.EditingJob())),mapViewModel.EditingJob(void 0)})},e.prototype.DeleteJob=function(){var e=mapViewModel.DeletingJob();e.DeleteOnServer().done(function(){mapViewModel.Jobs.remove(e),void 0!==e.SuperJobId()&&mapViewModel.GetJobById(e.SuperJobId()).SubJobs.remove(e),mapViewModel.DeletingJob(void 0)})},e.prototype.SaveLogBookEntry=function(){var e=this,o=void 0===e.Id();e.SaveToServer().done(function(){o&&mapViewModel.LogBookEntries.push(mapViewModel.EditingLogBookEntry()),mapViewModel.EditingLogBookEntry(void 0)})},e.prototype.DeleteLogBookEntry=function(){var e=mapViewModel.DeletingLogBookEntry();e.DeleteOnServer().done(function(){mapViewModel.LogBookEntries.remove(e),mapViewModel.DeletingLogBookEntry(void 0)})},e.prototype.SetOptionKey=function(e,o){ko.applyBindingsToNode(e,{attr:{"data-id":o.Id}},o),ko.applyBindingsToNode(e,{attr:{value:o.Id}},o)},e.prototype.SavePerson=function(){mapViewModel.EditingPerson().SaveToServer().done(function(){mapViewModel.Persons.push(mapViewModel.EditingPerson()),mapViewModel.EditingPerson(void 0)})},e.prototype.DeletePerson=function(){mapViewModel.DeletingPerson().DeleteOnServer().done(function(){mapViewModel.Persons.remove(mapViewModel.DeletingPerson()),mapViewModel.DeletingPerson(void 0)})},e}(),mapViewModel=new MapViewModel(MapMode.View),dropzoneModalOpenedByDrag=!1,dropzoneModal=$("#dropzoneModal"),editingLogBookEntryModal=$("#editingLogBookEntryModal"),detailedLogBookEntryModal=$("#detailedLogBookEntryModal"),editingHarbourModal=$("#editingHarbourModal"),deletingHarbourModal=$("#deletingHarbourModal"),editingWaypointModal=$("#editingWaypointModal"),deletingWaypointModal=$("#deletingWaypointModal"),deletingJobModal=$("#deletingJobModal"),editingJobModal=$("#editingJobModal"),jobOverviewModal=$("#jobOverviewModal"),editingPersonModal=$("#editingPersonModal"),deletingPersonModal=$("#deletingPersonModal"),personOverviewModal=$("#personOverviewModal"),dropzone,hasDrag=!1,uploadModalVisible=!1,pswp=$(".pswp")[0],personDeails=$("#personDetails"),Person=ClientModel.Person,deletePerson=$("#deletePerson"),leftSidebar=new Sidebar($("#leftSidebar")),rightSidebar=new Sidebar($("#rightSidebar")),bottomSidebar=new Sidebar($("#bottomSidebar")),harbourInfo=$("#harbourInfo");Dropzone.options.dropzone={acceptedFiles:"image/jpeg,image/png",dictInvalidFileType:"Dieser Dateityp wird nicht unterstützt",dictDefaultMessage:"Dateien hier ablegen",init:function(){dropzone=this,dropzone.on("success",function(e,o){var i=(new ClientModel.Image).LoadFromServerEntity(o.Image);mapViewModel.Images.push(i),mapViewModel.GetAlbumById(o.AlbumId).Images.push(i)}),dropzone.on("queuecomplete",function(){dropzoneModalOpenedByDrag&&dropzoneModal.modal("hide")}),dropzone.on("dragover",function(){hasDrag=!0})}},document.ondragenter=function(e){uploadModalVisible||hasDrag||dropzoneModalOpenedByDrag||!dropzoneModal.is(":not(.in)")||"Files"!==e.dataTransfer.types[0]||void 0===mapViewModel.SelectedHarbour()||(dropzoneModal.modal("show"),uploadModalVisible=!0,dropzoneModalOpenedByDrag=!0),hasDrag=!0,e.preventDefault(),e.stopPropagation()},document.ondragover=function(e){hasDrag=!0},document.ondragleave=function(e){(uploadModalVisible&&hasDrag&&dropzoneModalOpenedByDrag&&0===dropzone.getQueuedFiles().length||0===dropzone.getUploadingFiles().length)&&(hasDrag=!1,window.setTimeout(function(){hasDrag||(dropzoneModal.modal("hide"),uploadModalVisible=!1)},1e3)),e.preventDefault(),e.stopPropagation()},dropzoneModal.on("hide.bs.modal",function(e){return dropzone.getQueuedFiles().length>0||dropzone.getUploadingFiles().length>0?(e.preventDefault(),e.stopImmediatePropagation(),alert("Das Fenster kann nicht geschlossen werden, während Dateien hochgeladen werden."),!1):(dropzone.removeAllFiles(),void(dropzoneModalOpenedByDrag=!1))});var gallery;$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(e){"undefined"==typeof $("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),
$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),ko.bindingHandlers.daterange={init:function(e,o,i,a,t){var n=o()();void 0===n&&o()((new Date).toJSON()),n=o()(),$(e).daterangepicker({singleDatePicker:!0,timePicker:!0,timePicker24Hour:!0,autoApply:!0,startDate:n,endDate:n},function(e,i,a){o()(e._d.toJSON())})},update:function(e,o,i,a,t){$(e).data("daterangepicker").setStartDate(moment(o()()))}};
//# sourceMappingURL=Map.min.js.map
