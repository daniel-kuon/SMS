function renderTime(e,o){if(e instanceof Date)return renderTime(o.getTime()-e.getTime());var t=e,i=Math.floor(t/6e4),n=(i%60).toString();return 1===n.length&&(n="0"+n),i=Math.floor(i/60),i.toString()+":"+n}function getMiddle(e){var o=e.getLatLngs()[0],t=e.getLatLngs()[1];return new L.LatLng(o.lat+(t.lat-o.lat)/2,o.lng+(t.lng-o.lng)/2)}function splitPolyline(e){if(2===e.Waypoints.length&&e.DummyHandle instanceof Waypoint){var o=(e.Waypoints[0],e.DummyHandle),t=e.Waypoints[1];return o.RemoveFromPolyline(e),e.DummyHandle=void 0,o.AddToPolyline(e),t.RemoveFromPolyline(e),addDummyHandle(e),void addDummyHandle(mapViewModel.AddPolyline([o,t]))}throw new Error("Cannot split polyline. Polyline has no dummy handle or less or more than 2 waypoints")}function removePolyline(e){for(var o=0,t=e.Waypoints;o<t.length;o++){var i=t[o];i.RemoveFromPolyline(e)}void 0!==e.DummyHandle&&(e.DummyHandle.RemoveFromPolyline(e),e.DummyHandle.RemoveFromMap()),mapViewModel.Map.removeLayer(e)}function addDummyHandle(e){void 0===e.DummyHandle&&(e.DummyHandle=mapViewModel.CreateWaypoint(getMiddle(e),MarkerType.Dummy),e.DummyHandle.AddToPolyline(e))}function redrawPolyline(e){var o=getMiddle(e);void 0===e.DummyHandle&&addDummyHandle(e),e.DummyHandle.Longitude()!==o.lng||e.DummyHandle.Latitude()!==o.lat?e.DummyHandle.SetLatLng(o):e.redraw()}function removeFromPolyline(e,o){removeFromArray(e.getLatLngs(),o),e.redraw()}function removeFromArray(e,o){for(var t=new Array,i=0,n=e;i<n.length;i++){var a=n[i];a!==o&&t.push(a)}if(t.length===e.length)return!1;for(;e.pop(););for(;t.length>0;)e.push(t.shift());return!0}var Waypoint=ClientModel.Waypoint,Harbour=ClientModel.Harbour,WaypointDistance=ClientModel.WaypointDistance,ctrlPressed=!1;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("body").addClass("mobile");var MapMode;!function(e){e[e.Admin=0]="Admin",e[e.View=1]="View",e[e.TripPlanning=2]="TripPlanning",e[e.RouteDrawing=3]="RouteDrawing"}(MapMode||(MapMode={}));var EditingHelper=function(){function e(e,o,t,i,n){var a=this;this.Factory=t,this.Dataset=i,this.EditingModalOpen=!1,this.DeletingModalOpen=!1,this.DetailModalOpen=!1,this.HasDetailView=!1,this.Detail=ko.observable(),this.Editing=ko.observable(),this.Deleting=ko.observable(),this.Delete=function(){a.Deleting().DeleteOnServer().done(function(){a.Deleting(void 0),void 0!==a.Detail()&&a.Detail(void 0),void 0!==a.Editing()&&a.Editing(void 0)})},this.Save=function(){if(void 0!==a.Parsley)a.Parsley.whenValidate().done(function(){void 0===a.Editing().Id();a.Editing().SaveToServer().done(function(){a.Editing(void 0)})});else{void 0===a.Editing().Id();a.Editing().SaveToServer().done(function(){a.Editing(void 0)})}},this.EditingModal=$("#"+e),this.DeletingModal=$("#"+o),1===$("form:first").length&&(this.Parsley=$("form:first",this.EditingModal).parsley(window.ParsleyConfig)),this.EditingModal.on("show.bs.modal",function(){a.EditingModalOpen=!0,void 0===a.Editing()&&a.Editing(a.Factory()),mapViewModel.AlbumStack.unshift(a.Editing().Album())}),this.EditingModal.on("shown.bs.modal",function(){window.setTimeout(function(){return $("input, select, textarea",a.EditingModal).first().focus()},200)}),this.EditingModal.on("hidden.bs.modal",function(){void 0!==a.Editing()&&a.Editing(void 0),a.EditingModalOpen=!1,mapViewModel.AlbumStack.shift()}),this.Editing.subscribe(function(e){void 0===e&&a.EditingModalOpen?a.EditingModal.modal("hide"):a.EditingModalOpen||(e.SaveState(),a.EditingModal.modal("show"))}),this.Editing.subscribe(function(){void 0!==a.Editing()&&a.Editing().RevertState(!0)},this,"beforeChange"),this.DeletingModal.on("show.bs.modal",function(){a.DeletingModalOpen=!0,mapViewModel.AlbumStack.unshift(void 0)}),this.DeletingModal.on("hidden.bs.modal",function(){void 0!==a.Deleting()&&a.Deleting(void 0),mapViewModel.AlbumStack.shift(),a.DeletingModalOpen=!1}),this.Deleting.subscribe(function(e){void 0===e&&a.DeletingModalOpen?a.DeletingModal.modal("hide"):a.DeletingModalOpen||a.DeletingModal.modal("show")}),void 0!==n&&(this.HasDetailView=!0,n instanceof Sidebar?(this.DetailSidebar=n,this.Detail.subscribe(function(e){void 0===e&&a.DetailSidebar.IsActiv()?(mapViewModel.AlbumStack.shift(),a.DetailSidebar.Hide()):void 0===e||a.DetailSidebar.IsActiv()||(a.DetailSidebar.Show(),mapViewModel.AlbumStack.unshift(e.Album()))})):(this.DetailModal=$("#"+n),this.Detail.subscribe(function(e){void 0===e&&a.DetailModalOpen?a.DetailModal.modal("hide"):void 0===e||a.DetailModalOpen||a.DetailModal.modal("show")}),this.DetailModal.on("show.bs.modal",function(){a.DetailModalOpen=!0,mapViewModel.AlbumStack.unshift(a.Detail().Album())}),this.DetailModal.on("hide.bs.modal",function(){a.DetailModalOpen=!1,mapViewModel.AlbumStack.shift()})))}return e}(),MapViewModel=function(){function e(e){var o=this;this.IsLoggedIn=ko.observable(!1),this.routePolyline=ko.observable(),this.IsLastTakInRoute=ko.computed({read:function(){var e=mapViewModel.TripHelper.Editing(),o=mapViewModel.HarbourHelper.Detail();return void 0!==e&&void 0!==o&&e.Tacks()[e.Tacks().length-1].Start()===o},deferEvaluation:!0}),this.GetRouteDistance=ko.computed({read:function(){for(var e=0,o=0,t=mapViewModel.TripHelper.Editing().Tacks();o<t.length;o++){var i=t[o];isNaN(i.Distance())||(e+=i.Distance())}return e},deferEvaluation:!0}),this.TopJobs=ko.computed({read:function(){return mapViewModel.Jobs().filter(function(e){return void 0===e.SuperJobId()})},deferEvaluation:!0}),this.IsInViewMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.View},deferEvaluation:!0}),this.IsInAdminMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.Admin},deferEvaluation:!0}),this.WaypointsLoaded=!1,this.WaypointConnectionsLoaded=!1,this.PersonsLoaded=!1,this.JobsLoaded=!1,this.TripsLoaded=!1,this.AddressesLoaded=!1,this.ImagesLoaded=!1,this.AlbumsLoaded=!1,this.WaypointTacksLoaded=!1,this.TacksLoaded=!1,this.LocationsLoaded=!1,this.AlbumImagesLoaded=!1,this.LogBookEntriesLoaded=!1,this.CrewsLoaded=!1,this.WifisLoaded=!1,this.ContentPagesLoaded=!1,this.Waypoints=ko.observableArray(),this.WaypointConnections=ko.observableArray(),this.Harbours=ko.observableArray(),this.Persons=ko.observableArray(),this.Jobs=ko.observableArray(),this.Trips=ko.observableArray(),this.Addresses=ko.observableArray(),this.Images=ko.observableArray(),this.Tacks=ko.observableArray(),this.Locations=ko.observableArray(),this.Supermarkets=ko.observableArray(),this.Restaurants=ko.observableArray(),this.Albums=ko.observableArray(),this.AlbumImages=ko.observableArray(),this.LogBookEntries=ko.observableArray(),this.Crews=ko.observableArray(),this.Wifis=ko.observableArray(),this.ContentPages=ko.observableArray(),this.WaypointHelper=new EditingHelper("editingWaypointModal","deletingWaypointModal",function(){return o.CreateWaypoint(MarkerType.Waypoint)},this.Waypoints),this.HarbourHelper=new EditingHelper("editingHarbourModal","deletingHarbourModal",function(){return o.CreateHarbour()},this.Harbours,rightSidebar),this.PersonHelper=new EditingHelper("editingPersonModal","deletingPersonModal",function(){return new ClientModel.Person},this.Persons),this.JobHelper=new EditingHelper("editingJobModal","deletingJobModal",function(){return new ClientModel.Job},this.Jobs),this.TripHelper=new EditingHelper("editingTripModal","deletingTripModal",function(){return new ClientModel.Trip},this.Trips),this.AddressHelper=new EditingHelper("editingAddressModal","deletingAddressModal",function(){return new ClientModel.Address},this.Addresses),this.ImageHelper=new EditingHelper("editingImageModal","deletingImageModal",function(){return new ClientModel.Image},this.Images),this.TackHelper=new EditingHelper("editingTackModal","deletingTackModal",function(){return new ClientModel.Tack},this.Tacks),this.LocationHelper=new EditingHelper("editingLocationModal","deletingLocationModal",function(){return new ClientModel.Location},this.Locations),this.SupermarketHelper=new EditingHelper("editingSupermarketModal","deletingSupermarketModal",function(){return new ClientModel.Supermarket},this.Supermarkets),this.RestaurantHelper=new EditingHelper("editingRestaurantModal","deletingRestaurantModal",function(){return new ClientModel.Restaurant},this.Restaurants),this.LogBookEntryHelper=new EditingHelper("editingLogBookEntryModal","deletingLogBookEntryModal",function(){var e=new ClientModel.LogBookEntry;if(o.LogBookEntries().length>0){for(var t=o.LogBookEntries()[0],i=0,n=o.LogBookEntries();i<n.length;i++){var a=n[i];new Date(a.EndDate())>new Date(t.EndDate())&&(t=a)}e.Start(t.End()),e.MotorHoursStart(t.MotorHoursEnd()),e.LogStart(t.LogEnd()),"Lippe"!==t.End().Name()&&e.Persons(t.Persons().slice())}return e},this.LogBookEntries,"detailedLogBookEntryModal"),this.ContentPageHelper=new EditingHelper("editingContentPageModal","deletingContentPageModal",function(){return new ClientModel.ContentPage},this.ContentPages,"detailedContentPageModal"),this.WifiHelper=new EditingHelper("editingWifiModal","deletingWifiModal",function(){var e=new ClientModel.Wifi;return e.HarbourId(mapViewModel.HarbourHelper.Detail().Id()),e},this.Wifis,"detailWifiModal"),this.HarboursByName=ko.computed(function(){return o.Harbours.sort(function(e,o){return e.Name()>o.Name()?1:-1})()}),this.HarboursByDistance=ko.computed(function(){return o.Harbours.sort(function(e,o){return e.Distance()-o.Distance()})()}),this.LogBookEntriesByStartDate=ko.computed(function(){return o.LogBookEntries.sort(function(e,o){return Date.parse(e.StartDate())-Date.parse(o.StartDate())})()}),this.RemoveHarbour=function(){mapViewModel.HarbourHelper.Detail().DeleteOnServer()},this.RemoveWaypoint=function(){mapViewModel.WaypointHelper.Detail().DeleteOnServer()},this.MapMode=ko.observable(),this.RemovePolyline=function(e){o.Map.removeLayer(e),o.DrawingPolyline=void 0},this.routeFixed=!1,this.noRevertToPreviousBounds=!1,this.Polylines=new Array,this.WaypointMarkers=new Array,this.HarboursToSelect=ko.computed(function(){return o.HarboursByName().concat([{Name:"Neuer Hafen...",IsDummy:!0}])}),this.ProcessHarbourSelectOptions=function(e,t){if(void 0!==t&&null!==t&&t.IsDummy===!0){e.value="filled";var i=ko.contextFor(e),n=$(e).parent();void 0===n.data("new-change-handler")&&n.data("new-change-handler",n.change(function(){if($(e).is(":selected")){var t=o.CreateHarbour();o.HarbourHelper.Editing(t);var n=o.HarbourHelper.Editing.subscribe(function(){void 0!==t.Id()?(o.Harbours.push(t),i.$data.Harbour(t)):(t.RemoveFromMap(),i.$data.Harbour(void 0)),n.dispose()})}}))}},this.PersonsToSelect=ko.computed(function(){return o.Persons().sort(function(e,o){return e.FullName()>o.FullName()?1:-1}).concat([{FullName:"Neue Person...",IsDummy:!0}])}),this.ProcessPersonSelectOptions=function(e,t){if(void 0!==t&&null!==t&&t.IsDummy===!0){e.value="filled";var i=ko.contextFor(e),n=$(e).parent();void 0===n.data("new-change-handler")&&n.data("new-change-handler",n.change(function(){if($(e).is(":selected")){var t=new Person;o.PersonHelper.Editing(t);var n=o.PersonHelper.Editing.subscribe(function(){void 0!==t.Id()?(o.Persons.push(t),i.$data.Person(t)):i.$data.Person(void 0),n.dispose()})}}))}},this.AlbumStack=ko.observableArray(),this.GetPositionForWaypoint=function(e){navigator.geolocation.getCurrentPosition(function(o){e.Latitude(o.coords.latitude),e.Longitude(o.coords.longitude)},function(){console.log(arguments),alert("Die Position konnte nicht abgerufen werden")})},this.LogBookPager=new Pager(this.LogBookEntries,{Columns:[new PagerColumn("Start",function(e){return e.Start().Name},{Sorter:PagerColumn.StringSorter(),Visible:!1}),new PagerColumn("Ziel",function(e){return e.End().Name},{Sorter:PagerColumn.StringSorter(),Width:200}),new PagerColumn("Datum",function(e){return e.StartDate},{Sorter:PagerColumn.DateSorter(),Renderer:PagerColumn.DateRenderer(),Width:150,SortMode:SortModes.Descending}),new PagerColumn("Dauer",function(e){return e.SaillingTime},{Sorter:PagerColumn.StringSorter()}),new PagerColumn("Crew",function(e){return e.Persons},{Renderer:PagerColumn.ArrayRenderer("<br />",function(e){return e.FullName()}),Width:150}),new PagerColumn("Besondere Vorkomnisse",function(e){return e.SpecialOccurences})],UseResponsiveTable:!0,UseStripedTable:!0,EditingHelper:this.LogBookEntryHelper,ShowEditDeleteControls:!0,IdPrefix:"logBookOverview_",SpecialActions:[new PagerSpecialAction("Neuer Eintrag",function(){return $("#editingLogBookEntryModal").modal("show")},void 0,this.IsLoggedIn)]}),this.HarbourDistancePager=new Pager(ko.computed(function(){return o.Harbours().slice().filter(function(e){return e.Distance()>0})}),{Columns:[new PagerColumn("Name",function(e){return e.Name},{Sorter:PagerColumn.StringSorter()}),new PagerColumn("Entfernung",function(e){return e.Distance},{Sorter:PagerColumn.NumberSorter(),Renderer:function(e){return e+" sm"},SortMode:SortModes.Ascending})],EditingHelper:this.HarbourHelper,UseResponsiveTable:!0,UseStripedTable:!0,UseSmallColumnControls:!0,ShowColumnSelector:!1,IdPrefix:"harbourDistance_",SpecialColumnActions:[new PagerSpecialColumnAction("Route zeigen",function(e){o.ShowRoute(e),o.FixRoute()})]}),L.mapbox.accessToken="pk.eyJ1IjoiZGFuaWVsLWt1b24iLCJhIjoiY2lldnVtY29iMDBiOHQxbTBvZzBqZWl6cCJ9.UEc2YqH59pB1YTpv22vg8A",this.MapMode(e),this.MapMode.subscribe(function(){o.InitializeMap()});var t={contextmenu:e===MapMode.Admin,contextmenuItems:[{text:"Neuer Hafen",callback:function(e){console.log(e),mapViewModel.HarbourHelper.Editing(mapViewModel.CreateHarbour("",e.latlng))}}]};this.Map=L.mapbox.map("map","mapbox.streets",t),this.Map.setView([54.40774166820069,10.523529052734373],9),L.tileLayer("http://t1.openseamap.org/seamark/{z}/{x}/{y}.png").addTo(this.Map),this.LoadData(),$.get("/Account/IsLoggedIn").done(function(e){return o.IsLoggedIn(e)}),this.ContentPages.subscribe(function(e){var o=$("#leftNav");$(".contentPageLink",o).remove();for(var t=function(e){$('<li role="presentation" class="contentPageLink"><a href="#">'+e.Title()+"</a></li>").click(function(){return mapViewModel.ContentPageHelper.Detail(e),!1}).appendTo(o)},i=0,n=e;i<n.length;i++){var a=n[i];t(a)}}),this.HarbourHelper.Detail.subscribe(function(e){if(void 0!==e)mapViewModel.CalculateDistances(e),mapViewModel.Harbours.sort(function(e,o){return e.Distance()-o.Distance()});else for(var o=0,t=mapViewModel.Harbours();o<t.length;o++){var i=t[o];i.Distance(0)}mapViewModel.routeFixed=!1,mapViewModel.HideRoute()}),this.HarbourHelper.Editing.subscribe(function(e){void 0!==e&&void 0===e.Id()&&mapViewModel.Map.removeLayer(e.marker)},this,"beforeChange"),this.Map.addEventListener("mousemove",function(e){if(o.GetMapMode()===MapMode.RouteDrawing&&(o.DrawingLatLng.lat=e.latlng.lat,o.DrawingLatLng.lng=e.latlng.lng,o.DrawingPolyline.redraw()),o.MapMode()===MapMode.Admin)for(var t=0,i=o.WaypointMarkers;t<i.length;t++){var n=i[t];n.Point.distanceTo(e.containerPoint)<150?n.setOpacity(n.Waypoint.IsDummy()?0:1):n.setOpacity(n.Waypoint.IsDummy()?0:.8)}if(void 0!==mapViewModel.HoveredPolyine&&void 0!==mapViewModel.HoveredPolyine.DummyHandle){var a=mapViewModel.HoveredPolyine,r=mapViewModel.Map.latLngToContainerPoint(a.getLatLngs()[0]),d=mapViewModel.Map.latLngToContainerPoint(a.getLatLngs()[1]);r.distanceTo(e.containerPoint)<20||d.distanceTo(e.containerPoint)<20?mapViewModel.HoveredPolyine=void 0:(mapViewModel.HoveredPolyine.DummyHandle.marker.setOpacity(.8),mapViewModel.HoveredPolyine.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,r,d)),!1))}}),this.Map.addEventListener("click",function(e){if(o.GetMapMode()===MapMode.RouteDrawing){var t=mapViewModel.CreateWaypoint(e.latlng,MarkerType.Waypoint),i=o.DrawingPolyline.Waypoints[0].Id();t.SaveToServer().done(function(e){ServerApi.WaypointConnections.Connect(e.Id,i)}),t.AddToPolyline(o.DrawingPolyline),addDummyHandle(o.DrawingPolyline),removeFromPolyline(o.DrawingPolyline,o.DrawingLatLng),o.DrawingPolyline=o.AddPolyline(t),o.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),o.DrawingPolyline.addLatLng(o.DrawingLatLng)}}),this.Map.addEventListener("dblclick",function(e){o.GetMapMode()===MapMode.RouteDrawing&&(e.originalEvent.cancelBubble=!0,e.originalEvent.preventDefault(),e.originalEvent.stopPropagation(),o.DrawingPolyline.addLatLng(e.latlng),o.DrawingLatLng=e.latlng)}),$(document).keyup(function(e){o.GetMapMode()===MapMode.RouteDrawing&&27===e.keyCode&&o.RemovePolyline(o.DrawingPolyline)}),this.Map.addEventListener("move",function(e){for(var t=0,i=o.WaypointMarkers;t<i.length;t++){var n=i[t];n.Point=o.Map.latLngToContainerPoint(n.getLatLng())}}),this.Map.addEventListener("zoom",function(e){for(var t=0,i=o.WaypointMarkers;t<i.length;t++){var n=i[t];n.Point=o.Map.latLngToContainerPoint(n.getLatLng())}})}return e.prototype.StartRoute=function(){var e=new ClientModel.Trip,o=new ClientModel.Tack,t=mapViewModel.HarbourHelper.Detail();o.Start(t),e.Tacks.push(o),mapViewModel.TripHelper.Editing(e),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map)},e.prototype.AddToRoute=function(){var e=mapViewModel.TripHelper.Editing(),o=mapViewModel.HarbourHelper.Editing(),t=new ClientModel.Tack,i=e.Tacks()[e.Tacks().length-1],n=i.Start();mapViewModel.CalculateDistances(o,n),i.Distance(n.RouteDistance());var a=n;for(mapViewModel.routePolyline().addLatLng(a.LatLng);void 0!==a.RoutePrecessor();)a=a.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(a.LatLng);i.End(o),t.Start(o),e.Tacks.push(t)},e.prototype.RedrawTrip=function(){mapViewModel.Map.removeLayer(mapViewModel.routePolyline()),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map);for(var e=0,o=mapViewModel.TripHelper.Editing().Tacks();e<o.length;e++){var t=o[e],i=t.End(),n=t.Start();if(void 0!==i){mapViewModel.CalculateDistances(i,n),t.Distance(n.RouteDistance());var a=n;for(mapViewModel.routePolyline().addLatLng(a.LatLng);void 0!==a.RoutePrecessor();)a=a.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(a.LatLng)}}},e.prototype.PullTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,t=o.indexOf(e),i=o()[t-1],n=e.End();e.End(i.Start()),i.End(n),t>1&&o()[t-2].End(e.Start()),o.splice(t-1,2,e,i),mapViewModel.RedrawTrip()},e.prototype.PushTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,t=o.indexOf(e),i=o()[t+1];e.End(i.End()),i.End(e.Start()),t>0&&o()[t-1].End(i.Start()),o.splice(t,2,i,e),mapViewModel.RedrawTrip()},e.prototype.RemoveTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,t=o.indexOf(e),i=o()[t-1];void 0!==i&&i.End(e.End()),o.remove(e),mapViewModel.RedrawTrip()},e.prototype.LoadData=function(){var e=this;ServerApi.Waypoints.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];if("Waypoint"===n.Type)e.Waypoints.push(mapViewModel.CreateWaypoint(MarkerType.Waypoint).LoadFromServerEntity(n));else if("Harbour"===n.Type){var a=mapViewModel.CreateHarbour().LoadFromServerEntity(n);e.Harbours.push(a)}}e.WaypointsLoaded=!0,e.InitializeModel()}),ServerApi.WaypointConnections.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.WaypointConnections.push(n)}e.WaypointConnectionsLoaded=!0,e.InitializeModel()}),ServerApi.Persons.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Persons.push((new ClientModel.Person).LoadFromServerEntity(n))}e.PersonsLoaded=!0,e.InitializeModel()}),ServerApi.Jobs.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Jobs.push((new ClientModel.Job).LoadFromServerEntity(n))}e.JobsLoaded=!0,e.InitializeModel()}),ServerApi.Trips.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Trips.push((new ClientModel.Trip).LoadFromServerEntity(n))}e.TripsLoaded=!0,e.InitializeModel()}),ServerApi.Addresses.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Addresses.push((new ClientModel.Address).LoadFromServerEntity(n))}e.AddressesLoaded=!0,e.InitializeModel()}),ServerApi.Images.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Images.push((new ClientModel.Image).LoadFromServerEntity(n))}e.ImagesLoaded=!0,e.InitializeModel()}),ServerApi.Albums.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Albums.push((new ClientModel.Album).LoadFromServerEntity(n))}e.AlbumsLoaded=!0,e.InitializeModel()}),ServerApi.LogBookEntries.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.LogBookEntries.push((new ClientModel.LogBookEntry).LoadFromServerEntity(n))}e.LogBookEntriesLoaded=!0,e.InitializeModel()}),ServerApi.AlbumImages.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.AlbumImages.push(n)}e.AlbumImagesLoaded=!0,e.InitializeModel()}),ServerApi.Crews.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Crews.push(n)}e.CrewsLoaded=!0,e.InitializeModel()}),ServerApi.Wifis.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Wifis.push((new ClientModel.Wifi).LoadFromServerEntity(n))}e.WifisLoaded=!0,e.InitializeModel()}),ServerApi.ContentPages.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.ContentPages.push((new ClientModel.ContentPage).LoadFromServerEntity(n))}e.ContentPagesLoaded=!0,e.InitializeModel()}),ServerApi.Tacks.Get().done(function(o){for(var t=0,i=o;t<i.length;t++){var n=i[t];e.Tacks.push((new ClientModel.Tack).LoadFromServerEntity(n))}e.TacksLoaded=!0,e.InitializeModel()}),this.LocationsLoaded=!0},e.prototype.InitializeModel=function(){if(this.WaypointsLoaded&&this.WaypointConnectionsLoaded&&this.PersonsLoaded&&this.JobsLoaded&&this.TripsLoaded&&this.AddressesLoaded&&this.ImagesLoaded&&this.AlbumsLoaded&&this.TacksLoaded&&this.LocationsLoaded&&this.CrewsLoaded&&this.LogBookEntriesLoaded&&this.AlbumImagesLoaded&&this.WifisLoaded&&this.ContentPagesLoaded){for(var e=0,o=this.Jobs();e<o.length;e++){var t=o[e];void 0!==t.AssignedToId()&&t.AssignedTo(this.GetPersonById(t.AssignedToId())),void 0!==t.TripId()&&t.Trip(this.GetTripById(t.TripId())),void 0!==t.SuperJobId()&&(t.SuperJob(this.GetJobById(t.SuperJobId())),t.SuperJob().SubJobs.push(t))}for(var i=0,n=this.Harbours();i<n.length;i++){var t=n[i];t.Album(this.GetAlbumById(t.AlbumId()))}for(var a=0,r=this.Locations();a<r.length;a++){var t=r[a];t.Address(this.GetAddressById(t.AddressId())),this.GetHarbourById(t.HarbourId()).Locations.push(t)}for(var d=0,l=this.AlbumImages();d<l.length;d++){var t=l[d];this.GetAlbumById(t.AlbumId).Images.push(this.GetImageById(t.ImageId))}for(var s=0,p=mapViewModel.WaypointConnections();s<p.length;s++){var u=p[s],m=mapViewModel.AddPolyline([mapViewModel.GetWayPointById(u.Waypoint1Id),mapViewModel.GetWayPointById(u.Waypoint2Id)]);addDummyHandle(m)}for(var g=0,c=mapViewModel.LogBookEntries();g<c.length;g++){var M=c[g];M.Start(mapViewModel.GetHarbourById(M.StartId())),M.End(mapViewModel.GetHarbourById(M.EndId())),M.Album(mapViewModel.GetAlbumById(M.AlbumId()))}for(var v=0,h=mapViewModel.Crews();v<h.length;v++){var y=h[v],w=mapViewModel.GetLogBookEntryById(y.TackId),f=mapViewModel.GetTackById(y.TackId),b=mapViewModel.GetTripById(y.TackId),L=mapViewModel.GetPersonById(y.PersonId);void 0!==w?w.Persons.push(L):void 0!==f?f.Persons.push(L):void 0!==b&&b.Persons.push(L)}for(var D=0,P=mapViewModel.Wifis();D<P.length;D++){var k=P[D],V=mapViewModel.GetHarbourById(k.HarbourId());V.Wifis.push(k),k.Harbour(V)}ko.applyBindings(mapViewModel),$("#loadingOverlay").remove()}},e.prototype.InitializeMap=function(){mapViewModel.HarbourHelper.Detail(void 0);for(var e=0,o=mapViewModel.Waypoints();e<o.length;e++){var t=o[e];void 0!==t.marker&&mapViewModel.Map.removeLayer(t.marker),mapViewModel.CreateMarker(MarkerType.Waypoint,t)}for(var i=0,n=mapViewModel.Harbours();i<n.length;i++){var a=n[i];void 0!==a.marker&&mapViewModel.Map.removeLayer(a.marker),mapViewModel.CreateMarker(MarkerType.Harbour,a)}for(var r=0,d=mapViewModel.Polylines;r<d.length;r++){var l=d[r];void 0!==l.DummyHandle.marker&&mapViewModel.Map.removeLayer(l.DummyHandle.marker),mapViewModel.CreateMarker(MarkerType.Dummy,l.DummyHandle)}if(mapViewModel.MapMode()===MapMode.Admin){for(var s=0,p=mapViewModel.Polylines;s<p.length;s++){var l=p[s];l.addTo(mapViewModel.Map)}mapViewModel.Map.contextmenu.enable()}else{for(var u=0,m=mapViewModel.Polylines;u<m.length;u++){var l=m[u];mapViewModel.Map.removeLayer(l)}mapViewModel.Map.contextmenu.disable()}},e.prototype.GetWaypointById=function(e){for(var o=0,t=this.Waypoints();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}for(var n=0,a=this.Harbours();n<a.length;n++){var i=a[n];if(i.Id()===e)return i}},e.prototype.GetHarbourById=function(e){for(var o=0,t=this.Harbours();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetPersonById=function(e){for(var o=0,t=this.Persons();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetJobById=function(e){for(var o=0,t=this.Jobs();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetTripById=function(e){for(var o=0,t=this.Trips();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetAddressById=function(e){for(var o=0,t=this.Addresses();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetImageById=function(e){for(var o=0,t=this.Images();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetTackById=function(e){for(var o=0,t=this.Tacks();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetLogBookEntryById=function(e){for(var o=0,t=this.LogBookEntries();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetAlbumById=function(e){for(var o=0,t=this.Albums();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}},e.prototype.GetLocationById=function(e){for(var o=0,t=this.Locations();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}for(var n=0,a=this.Restaurants();n<a.length;n++){var i=a[n];if(i.Id()===e)return i}for(var r=0,d=this.Restaurants();r<d.length;r++){var i=d[r];if(i.Id()===e)return i}},e.prototype.InitGallery=function(e,o){for(var t=new Array,i=o.target.parentElement,n=this,a=0,r=mapViewModel.AlbumStack()[0].Images();a<r.length;a++){var d=r[a];t.push({h:d.Height(),w:d.Width(),src:d.Path()})}gallery=new PhotoSwipe(pswp,PhotoSwipeUI_Default,t,{index:mapViewModel.AlbumStack()[0].Images.indexOf(n),getThumbBoundsFn:function(e){var o=$("img",i)[e],t=parseFloat(window.getComputedStyle(o,null).getPropertyValue("padding-left").replace("px",""));o.scrollIntoView(!1);var n=o.getBoundingClientRect();return{x:n.left+t,y:n.top+window.screenY+t,w:n.width-2*t}}}),gallery.init()},e.prototype.AddHarbour=function(){var e=mapViewModel.CreateHarbour("Hafen "+this.Harbours.length,this.Map.getCenter());mapViewModel.Harbours.push(e),e.SaveToServer()},e.prototype.AddPolyline=function(e){var o=new L.Polyline([]);if(mapViewModel.Polylines.push(o),o.addEventListener("click",function(e){var t=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[0]),i=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[1]);o.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,t,i)),!1),mapViewModel.Waypoints.push(o.DummyHandle),o.DummyHandle.convertFromDummyHandle()}),mapViewModel.MapMode()===MapMode.Admin&&o.addTo(this.Map),o.Waypoints=new Array,void 0!==e)if(e instanceof Waypoint)e.AddToPolyline(o);else for(var t=0,i=e;t<i.length;t++){var n=i[t];n.AddToPolyline(o)}return o.addEventListener("mouseover",function(){mapViewModel.HoveredPolyine=o}),o},e.prototype.GetMapMode=function(){return void 0!==this.DrawingPolyline&&void 0!==this.DrawingLatLng?MapMode.RouteDrawing:this.MapMode()},e.prototype.GetWayPointById=function(e){for(var o=0,t=this.Waypoints();o<t.length;o++){var i=t[o];if(i.Id()===e)return i}for(var n=0,a=this.Harbours();n<a.length;n++){var i=a[n];if(i.Id()===e)return i}throw"No Waypoint with id "+e+" in model"},e.prototype.CalculateDistances=function(e,o){void 0===e&&(e=mapViewModel.HarbourHelper.Detail());var t=[e],i=new Array,n=new Array,a=void 0!==o;if(i.push(new WaypointDistance(void 0,e,0,t,a)),a){for(var r=0,d=mapViewModel.Waypoints();r<d.length;r++){var l=d[r];l.RoutePrecessor(void 0)}for(var s=0,p=mapViewModel.Harbours();s<p.length;s++){var u=p[s];u.RoutePrecessor(void 0)}}else{for(var m=0,g=mapViewModel.Waypoints();m<g.length;m++){var l=g[m];l.Precessor(void 0)}for(var c=0,M=mapViewModel.Harbours();c<M.length;c++){var u=M[c];u.Precessor(void 0)}}for(;i.length>0;){for(var v=Number.POSITIVE_INFINITY,h=void 0,y=0,w=i;y<w.length;y++){for(var l=w[y],f=0,b=l.ConnectedWayPoints;f<b.length;f++){var L=b[f];void 0!==(a?L.RoutePrecessor():L.Precessor())&&removeFromArray(l.ConnectedWayPoints,L)}if(0===l.ConnectedWayPoints.length)removeFromArray(i,l),n.push(l);else{var D=l.Distance+l.ConnectedWayPoints[0].LatLng.distanceTo(l.LatLng)/1.852;v>D&&(v=D,h=l)}}void 0!==h&&i.push(new WaypointDistance(h.Waypoint,h.ConnectedWayPoints.shift(),v,t,a))}if(a)for(var P=0,k=n;P<k.length;P++){var l=k[P];l.Waypoint.RouteDistance(Math.round(l.Distance/100)/10)}else for(var V=0,H=n;V<H.length;V++){var l=H[V];l.Waypoint.Distance(Math.round(l.Distance/100)/10)}},e.prototype.ShowRoute=function(e){if(void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.HideRoute()),void 0===e&&(e=this),e instanceof ClientModel.Harbour){var o=[e.LatLng],t=e.Distance();for(void 0!==t&&null!==t||(t=0);void 0!==e.Precessor();)e=e.Precessor(),o.push(e.LatLng);mapViewModel.highlightedRoute=L.polyline(o),mapViewModel.highlightedRoute.addTo(mapViewModel.Map),mapViewModel.highlightedRoute.bindLabel(t.toString()+" sm",{noHide:!0}),mapViewModel.FitBounds(mapViewModel.highlightedRoute.getBounds())}},e.prototype.FitBounds=function(e){var o=mapViewModel.Map,t=o.getBounds();t.contains(e)||(void 0===mapViewModel.previousBounds&&(mapViewModel.previousBounds=t),o.fitBounds(e))},e.prototype.HideRoute=function(e){if(void 0===e&&(e=!1),(!mapViewModel.routeFixed||e)&&void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.Map.removeLayer(mapViewModel.highlightedRoute),mapViewModel.highlightedRoute=void 0,!mapViewModel.noRevertToPreviousBounds&&void 0!==mapViewModel.previousBounds)){var o=mapViewModel.previousBounds;mapViewModel.previousBounds=void 0,window.setTimeout(function(){void 0===mapViewModel.previousBounds?mapViewModel.Map.fitBounds(o):mapViewModel.previousBounds=o},100)}},e.prototype.FixRoute=function(){mapViewModel.routeFixed=!0,mapViewModel.previousBounds=void 0},e.prototype.CreateWaypoint=function(e,o){var t;return t=void 0!==o?new Waypoint(e,o,mapViewModel.Map):new Waypoint(o,mapViewModel.Map),this.InitializeWaypoint(t,o),t},e.prototype.InitializeWaypoint=function(e,o){this.CreateMarker(o,e)},e.prototype.CreateMarker=function(e,o){if(mapViewModel.MapMode()===MapMode.Admin||e===MarkerType.Harbour){var t={draggable:mapViewModel.MapMode()===MapMode.Admin};e===MarkerType.Dummy&&(t.opacity=0),mapViewModel.MapMode()!==MapMode.Admin||e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(t.icon=new L.Icon({iconUrl:"/images/waypointhandle.png",iconSize:new L.Point(10,10,!0),className:"waypoint"})),mapViewModel.MapMode()===MapMode.Admin&&(t.contextmenu=!0,t.contextmenuInheritItems=!1,e===MarkerType.Harbour?t.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.HarbourHelper.Editing(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.HarbourHelper.Deleting(this)}}]:t.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.WaypointHelper.Editing(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.WaypointHelper.Deleting(this)}}]);var i=new L.Marker(o.LatLng,t);i.addTo(this.Map),i.Waypoint=o,o.marker=i,mapViewModel.MapMode()===MapMode.Admin?(e===MarkerType.Dummy&&i.addEventListener("mouseout",function(e){e.target.Waypoint.IsDummy()&&(mapViewModel.HoveredPolyine=void 0)}),i.addEventListener("drag",function(){o.SetLatLng(o.marker.getLatLng())}),e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(this.WaypointMarkers.push(o.marker),o.marker.Point=mapViewModel.Map.latLngToContainerPoint(o.LatLng)),
o.marker.addEventListener("click",function(){o.IsDummy()&&(mapViewModel.HoveredPolyine=void 0,o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)),mapViewModel.GetMapMode()===MapMode.RouteDrawing&&(o.IsInPolyline(mapViewModel.DrawingPolyline)?(removePolyline(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0):(ServerApi.WaypointConnections.Connect(o.Id(),mapViewModel.DrawingPolyline.Waypoints[0].Id()),o.AddToPolyline(mapViewModel.DrawingPolyline),removeFromPolyline(mapViewModel.DrawingPolyline,mapViewModel.DrawingLatLng),addDummyHandle(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0))}),o.marker.addEventListener("dblclick",function(e){mapViewModel.DrawingPolyline=mapViewModel.AddPolyline(o),mapViewModel.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),mapViewModel.DrawingPolyline.addLatLng(mapViewModel.DrawingLatLng)}),e===MarkerType.Dummy&&o.marker.addOneTimeEventListener("drag",function(){o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)}),o.marker.addEventListener("dragend",function(){o.SaveToServer()})):e===MarkerType.Harbour&&(o.marker.addEventListener("mouseover",function(){void 0!==mapViewModel.HarbourHelper.Detail()&&mapViewModel.ShowRoute(o)}),o.marker.addEventListener("click",function(){return mapViewModel.HarbourHelper.Detail(o)}))}},e.prototype.CreateHarbour=function(e,o){var t;return t=void 0!==o?new Harbour(o,this.Map):new Harbour(this.Map),t.Name(e),this.InitializeWaypoint(t,MarkerType.Harbour),t},e.prototype.SetOptionKey=function(e,o){ko.applyBindingsToNode(e,{attr:{"data-id":o.Id}},o),ko.applyBindingsToNode(e,{attr:{value:o.Id}},o)},e}(),dropzoneModalOpenedByDrag=!1,dropzoneModal=$("#dropzoneModal"),jobOverviewModal=$("#jobOverviewModal"),personOverviewModal=$("#personOverviewModal"),dropzone,hasDrag=!1,uploadModalVisible=!1,pswp=$(".pswp")[0],personDeails=$("#personDetails"),deletePerson=$("#deletePerson"),leftSidebar=new Sidebar($("#leftSidebar")),rightSidebar=new Sidebar($("#rightSidebar")),bottomSidebar=new Sidebar($("#bottomSidebar")),harbourInfo=$("#harbourInfo"),mapViewModel=new MapViewModel(MapMode.View);Dropzone.options.dropzone={acceptedFiles:"image/jpeg,image/png",dictInvalidFileType:"Dieser Dateityp wird nicht unterstützt",dictDefaultMessage:"Dateien hier ablegen",init:function(){dropzone=this,dropzone.on("success",function(e,o){var t=(new ClientModel.Image).LoadFromServerEntity(o.Image);mapViewModel.Images.push(t),mapViewModel.GetAlbumById(o.AlbumId).Images.push(t)}),dropzone.on("queuecomplete",function(){dropzoneModalOpenedByDrag&&dropzoneModal.modal("hide")}),dropzone.on("dragover",function(){hasDrag=!0})}},document.ondragenter=function(e){!mapViewModel.IsLoggedIn||uploadModalVisible||hasDrag||dropzoneModalOpenedByDrag||!dropzoneModal.is(":not(.in)")||"Files"!==e.dataTransfer.types[0]||void 0===mapViewModel.AlbumStack()[0]||(dropzoneModal.modal("show"),uploadModalVisible=!0,dropzoneModalOpenedByDrag=!0),hasDrag=!0,e.preventDefault(),e.stopPropagation()},document.ondragover=function(){hasDrag=!0},document.ondragleave=function(e){(uploadModalVisible&&hasDrag&&dropzoneModalOpenedByDrag&&0===dropzone.getQueuedFiles().length||0===dropzone.getUploadingFiles().length)&&(hasDrag=!1,window.setTimeout(function(){hasDrag||(dropzoneModal.modal("hide"),uploadModalVisible=!1)},1e3)),e.preventDefault(),e.stopPropagation()},dropzoneModal.on("hide.bs.modal",function(e){return dropzone.getQueuedFiles().length>0||dropzone.getUploadingFiles().length>0?(e.preventDefault(),e.stopImmediatePropagation(),alert("Das Fenster kann nicht geschlossen werden, während Dateien hochgeladen werden."),!1):(dropzone.removeAllFiles(),void(dropzoneModalOpenedByDrag=!1))});var gallery;$(".modal").on("hidden.bs.modal",function(){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(){"undefined"==typeof $("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),ko.bindingHandlers.daterange={init:function(e,o,t,i,n){var a=o()();void 0===a&&o()((new Date).toJSON()),a=o()(),$(e).daterangepicker({singleDatePicker:!0,showDropdowns:!0,timePicker:!0,timePicker24Hour:!0,timePickerIncrement:15,locale:{format:"DD.MM.YYYY HH:mm",separator:" - ",applyLabel:"Speichern",cancelLabel:"Abbrechen",fromLabel:"Von",toLabel:"Bis",customRangeLabel:"Custom",weekLabel:"W",daysOfWeek:["S0","Mo","Di","Mi","Do","Fr","Sa"],monthNames:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],firstDay:1},alwaysShowCalendars:!0,startDate:a,endDate:a},function(e){o()(e._d.toJSON())})},update:function(e,o,t,i,n){$(e).data("daterangepicker").setStartDate(moment(o()()))}},window.Parsley.on("form:validate",function(e){return void 0===e.submitEvent?!1:void 0}),window.Parsley.on("form:submit",function(e){return!1}),$(document).on("focusin",function(e){$(e.target).closest(".mce-window").length&&e.stopImmediatePropagation()});
//# sourceMappingURL=Map.min.js.map
