function renderTime(e,o){if(e instanceof Date)return renderTime(o.getTime()-e.getTime());var i=e,t=Math.floor(i/6e4),a=(t%60).toString();return 1===a.length&&(a="0"+a),t=Math.floor(t/60),t.toString()+":"+a}function getMiddle(e){var o=e.getLatLngs()[0],i=e.getLatLngs()[1];return new L.LatLng(o.lat+(i.lat-o.lat)/2,o.lng+(i.lng-o.lng)/2)}function splitPolyline(e){if(2===e.Waypoints.length&&e.DummyHandle instanceof Waypoint){var o=(e.Waypoints[0],e.DummyHandle),i=e.Waypoints[1];return o.RemoveFromPolyline(e),e.DummyHandle=void 0,o.AddToPolyline(e),i.RemoveFromPolyline(e),addDummyHandle(e),void addDummyHandle(mapViewModel.AddPolyline([o,i]))}throw new Error("Cannot split polyline. Polyline has no dummy handle or less or more than 2 waypoints")}function removePolyline(e){for(var o=0,i=e.Waypoints;o<i.length;o++){var t=i[o];t.RemoveFromPolyline(e)}void 0!==e.DummyHandle&&(e.DummyHandle.RemoveFromPolyline(e),e.DummyHandle.RemoveFromMap()),mapViewModel.Map.removeLayer(e)}function addDummyHandle(e){void 0===e.DummyHandle&&(e.DummyHandle=mapViewModel.CreateWaypoint(getMiddle(e),MarkerType.Dummy),e.DummyHandle.AddToPolyline(e))}function redrawPolyline(e){var o=getMiddle(e);void 0===e.DummyHandle&&addDummyHandle(e),e.DummyHandle.Longitude()!==o.lng||e.DummyHandle.Latitude()!==o.lat?e.DummyHandle.SetLatLng(o):e.redraw()}function removeFromPolyline(e,o){removeFromArray(e.getLatLngs(),o),e.redraw()}function removeFromArray(e,o){for(var i=new Array,t=0,a=e;t<a.length;t++){var n=a[t];n!==o&&i.push(n)}if(i.length===e.length)return!1;for(;e.pop(););for(;i.length>0;)e.push(i.shift());return!0}var Waypoint=ClientModel.Waypoint,Harbour=ClientModel.Harbour,Job=ClientModel.Job,WaypointDistance=ClientModel.WaypointDistance,ctrlPressed=!1;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("body").addClass("mobile");var MapMode;!function(e){e[e.Admin=0]="Admin",e[e.View=1]="View",e[e.TripPlanning=2]="TripPlanning",e[e.RouteDrawing=3]="RouteDrawing"}(MapMode||(MapMode={}));var EditingHelper=function(){function e(e,o,i,t,a){var n=this;this.Factory=i,this.Dataset=t,this.EditingModalOpen=!1,this.DeletingModalOpen=!1,this.DetailModalOpen=!1,this.Detail=ko.observable(),this.Editing=ko.observable(),this.Deleting=ko.observable(),this.Delete=function(){n.Deleting().DeleteOnServer().done(function(){n.Deleting(void 0),void 0!==n.Detail()&&n.Detail(void 0),void 0!==n.Editing()&&n.Editing(void 0)})},this.Save=function(){if(void 0!==n.Parsley)n.Parsley.whenValidate().done(function(){void 0===n.Editing().Id();n.Editing().SaveToServer().done(function(){n.Editing(void 0)})});else{void 0===n.Editing().Id();n.Editing().SaveToServer().done(function(){n.Editing(void 0)})}},this.EditingModal=$("#"+e),this.DeletingModal=$("#"+o),1===$("form:first").length&&(this.Parsley=$("form:first",this.EditingModal).parsley(window.ParsleyConfig)),this.EditingModal.on("show.bs.modal",function(){n.EditingModalOpen=!0,void 0===n.Editing()&&n.Editing(n.Factory()),mapViewModel.AlbumStack.unshift(n.Editing().Album())}),this.EditingModal.on("shown.bs.modal",function(){window.setTimeout(function(){return $("input, select, textarea",n.EditingModal).first().focus()},200)}),this.EditingModal.on("hidden.bs.modal",function(){void 0!==n.Editing()&&n.Editing(void 0),n.EditingModalOpen=!1,mapViewModel.AlbumStack.shift()}),this.Editing.subscribe(function(e){void 0===e&&n.EditingModalOpen?n.EditingModal.modal("hide"):n.EditingModalOpen||(e.SaveState(),n.EditingModal.modal("show"))}),this.Editing.subscribe(function(){void 0!==n.Editing()&&n.Editing().RevertState(!0)},this,"beforeChange"),this.DeletingModal.on("show.bs.modal",function(){n.DeletingModalOpen=!0,mapViewModel.AlbumStack.unshift(void 0)}),this.DeletingModal.on("hidden.bs.modal",function(){void 0!==n.Deleting()&&n.Deleting(void 0),mapViewModel.AlbumStack.shift(),n.DeletingModalOpen=!1}),this.Deleting.subscribe(function(e){void 0===e&&n.DeletingModalOpen?n.DeletingModal.modal("hide"):n.DeletingModalOpen||n.DeletingModal.modal("show")}),void 0!==a&&(a instanceof Sidebar?(this.DetailSidebar=a,this.Detail.subscribe(function(e){void 0===e&&n.DetailSidebar.IsActiv()?(mapViewModel.AlbumStack.shift(),n.DetailSidebar.Hide()):void 0===e||n.DetailSidebar.IsActiv()||(n.DetailSidebar.Show(),mapViewModel.AlbumStack.unshift(e.Album()))})):(this.DetailModal=$("#"+a),this.Detail.subscribe(function(e){void 0===e&&n.DetailModalOpen?n.DetailModal.modal("hide"):void 0===e||n.DetailModalOpen||n.DetailModal.modal("show")}),this.DetailModal.on("show.bs.modal",function(){n.DetailModalOpen=!0,mapViewModel.AlbumStack.unshift(n.Detail().Album())}),this.DetailModal.on("hide.bs.modal",function(){n.DetailModalOpen=!1,mapViewModel.AlbumStack.shift()})))}return e}(),MapViewModel=function(){function e(e){var o=this;this.IsLoggedIn=ko.observable(!1),this.routePolyline=ko.observable(),this.IsLastTakInRoute=ko.computed({read:function(){var e=mapViewModel.TripHelper.Editing(),o=mapViewModel.HarbourHelper.Detail();return void 0!==e&&void 0!==o&&e.Tacks()[e.Tacks().length-1].Start()===o},deferEvaluation:!0}),this.GetRouteDistance=ko.computed({read:function(){for(var e=0,o=0,i=mapViewModel.TripHelper.Editing().Tacks();o<i.length;o++){var t=i[o];isNaN(t.Distance())||(e+=t.Distance())}return e},deferEvaluation:!0}),this.TopJobs=ko.computed({read:function(){return mapViewModel.Jobs().filter(function(e){return void 0===e.SuperJobId()})},deferEvaluation:!0}),this.IsInViewMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.View},deferEvaluation:!0}),this.IsInAdminMode=ko.computed({read:function(){return mapViewModel.MapMode()===MapMode.Admin},deferEvaluation:!0}),this.WaypointsLoaded=!1,this.WaypointConnectionsLoaded=!1,this.PersonsLoaded=!1,this.JobsLoaded=!1,this.TripsLoaded=!1,this.AddressesLoaded=!1,this.ImagesLoaded=!1,this.AlbumsLoaded=!1,this.WaypointTacksLoaded=!1,this.TacksLoaded=!1,this.LocationsLoaded=!1,this.AlbumImagesLoaded=!1,this.LogBookEntriesLoaded=!1,this.CrewsLoaded=!1,this.WifisLoaded=!1,this.ContentPagesLoaded=!1,this.Waypoints=ko.observableArray(),this.WaypointConnections=ko.observableArray(),this.Harbours=ko.observableArray(),this.Persons=ko.observableArray(),this.Jobs=ko.observableArray(),this.Trips=ko.observableArray(),this.Addresses=ko.observableArray(),this.Images=ko.observableArray(),this.Tacks=ko.observableArray(),this.Locations=ko.observableArray(),this.Supermarkets=ko.observableArray(),this.Restaurants=ko.observableArray(),this.Albums=ko.observableArray(),this.AlbumImages=ko.observableArray(),this.LogBookEntries=ko.observableArray(),this.Crews=ko.observableArray(),this.Wifis=ko.observableArray(),this.ContentPages=ko.observableArray(),this.WaypointHelper=new EditingHelper("editingWaypointModal","deletingWaypointModal",function(){return o.CreateWaypoint(MarkerType.Waypoint)},this.Waypoints),this.HarbourHelper=new EditingHelper("editingHarbourModal","deletingHarbourModal",function(){return o.CreateHarbour()},this.Harbours,rightSidebar),this.PersonHelper=new EditingHelper("editingPersonModal","deletingPersonModal",function(){return new ClientModel.Person},this.Persons),this.JobHelper=new EditingHelper("editingJobModal","deletingJobModal",function(){return new ClientModel.Job},this.Jobs),this.TripHelper=new EditingHelper("editingTripModal","deletingTripModal",function(){return new ClientModel.Trip},this.Trips),this.AddressHelper=new EditingHelper("editingAddressModal","deletingAddressModal",function(){return new ClientModel.Address},this.Addresses),this.ImageHelper=new EditingHelper("editingImageModal","deletingImageModal",function(){return new ClientModel.Image},this.Images),this.TackHelper=new EditingHelper("editingTackModal","deletingTackModal",function(){return new ClientModel.Tack},this.Tacks),this.LocationHelper=new EditingHelper("editingLocationModal","deletingLocationModal",function(){return new ClientModel.Location},this.Locations),this.SupermarketHelper=new EditingHelper("editingSupermarketModal","deletingSupermarketModal",function(){return new ClientModel.Supermarket},this.Supermarkets),this.RestaurantHelper=new EditingHelper("editingRestaurantModal","deletingRestaurantModal",function(){return new ClientModel.Restaurant},this.Restaurants),this.LogBookEntryHelper=new EditingHelper("editingLogBookEntryModal","deletingLogBookEntryModal",function(){return new ClientModel.LogBookEntry},this.LogBookEntries,"detailedLogBookEntryModal"),this.ContentPageHelper=new EditingHelper("editingContentPageModal","deletingContentPageModal",function(){return new ClientModel.ContentPage},this.ContentPages,"detailedContentPageModal"),this.WifiHelper=new EditingHelper("editingWifiModal","deletingWifiModal",function(){var e=new ClientModel.Wifi;return e.HarbourId(mapViewModel.HarbourHelper.Detail().Id()),e},this.Wifis,"detailWifiModal"),this.RemoveHarbour=function(){mapViewModel.HarbourHelper.Detail().DeleteOnServer()},this.RemoveWaypoint=function(){mapViewModel.WaypointHelper.Detail().DeleteOnServer()},this.MapMode=ko.observable(),this.RemovePolyline=function(e){o.Map.removeLayer(e),o.DrawingPolyline=void 0},this.routeFixed=!1,this.noRevertToPreviousBounds=!1,this.Polylines=new Array,this.WaypointMarkers=new Array,this.HarboursToSelect=ko.computed(function(){return o.Harbours().concat([{Name:"Neuer Hafen...",IsDummy:!0}])}),this.ProcessHarbourSelectOptions=function(e,i){if(void 0!==i&&null!==i&&i.IsDummy===!0){e.value="filled";var t=ko.contextFor(e),a=$(e).parent();void 0===a.data("new-change-handler")&&a.data("new-change-handler",a.change(function(){if($(e).is(":selected")){var i=o.CreateHarbour();o.HarbourHelper.Editing(i);var a=o.HarbourHelper.Editing.subscribe(function(){void 0!==i.Id()?(o.Harbours.push(i),t.$data.Harbour(i)):(i.RemoveFromMap(),t.$data.Harbour(void 0)),a.dispose()})}}))}},this.PersonsToSelect=ko.computed(function(){return o.Persons().concat([{FullName:"Neue Person...",IsDummy:!0}])}),this.ProcessPersonSelectOptions=function(e,i){if(void 0!==i&&null!==i&&i.IsDummy===!0){e.value="filled";var t=ko.contextFor(e),a=$(e).parent();void 0===a.data("new-change-handler")&&a.data("new-change-handler",a.change(function(){if($(e).is(":selected")){var i=new Person;o.PersonHelper.Editing(i);var a=o.PersonHelper.Editing.subscribe(function(){void 0!==i.Id()?(o.Persons.push(i),t.$data.Person(i)):t.$data.Person(void 0),a.dispose()})}}))}},this.AlbumStack=ko.observableArray(),L.mapbox.accessToken="pk.eyJ1IjoiZGFuaWVsLWt1b24iLCJhIjoiY2lldnVtY29iMDBiOHQxbTBvZzBqZWl6cCJ9.UEc2YqH59pB1YTpv22vg8A",this.MapMode(e),this.MapMode.subscribe(function(){o.InitializeMap()});var i={contextmenu:e===MapMode.Admin,contextmenuItems:[{text:"Neuer Hafen",callback:function(e){console.log(e),mapViewModel.HarbourHelper.Editing(mapViewModel.CreateHarbour("",e.latlng))}}]};this.Map=L.mapbox.map("map","mapbox.streets",i),this.Map.setView([54.40774166820069,10.523529052734373],9),L.tileLayer("http://t1.openseamap.org/seamark/{z}/{x}/{y}.png").addTo(this.Map),this.LoadData(),$.get("/Account/LoggedIn").done(function(e){return o.IsLoggedIn(e)}),this.ContentPages.subscribe(function(e){var o=$("#leftNav");$(".contentPageLink",o).remove();for(var i=function(e){$('<li role="presentation" class="contentPageLink"><a href="#">'+e.Title()+"</a></li>").click(function(){return mapViewModel.ContentPageHelper.Detail(e),!1}).appendTo(o)},t=0,a=e;t<a.length;t++){var n=a[t];i(n)}}),this.HarbourHelper.Detail.subscribe(function(e){if(void 0!==e)mapViewModel.CalculateDistances(e),mapViewModel.Harbours.sort(function(e,o){return e.Distance()-o.Distance()});else for(var o=0,i=mapViewModel.Harbours();o<i.length;o++){var t=i[o];t.Distance(0)}mapViewModel.routeFixed=!1,mapViewModel.HideRoute()}),this.HarbourHelper.Editing.subscribe(function(e){void 0!==e&&void 0===e.Id()&&mapViewModel.Map.removeLayer(e.marker)},this,"beforeChange"),this.Map.addEventListener("mousemove",function(e){if(o.GetMapMode()===MapMode.RouteDrawing&&(o.DrawingLatLng.lat=e.latlng.lat,o.DrawingLatLng.lng=e.latlng.lng,o.DrawingPolyline.redraw()),o.MapMode()===MapMode.Admin)for(var i=0,t=o.WaypointMarkers;i<t.length;i++){var a=t[i];a.Point.distanceTo(e.containerPoint)<150?a.setOpacity(a.Waypoint.IsDummy()?0:1):a.setOpacity(a.Waypoint.IsDummy()?0:.8)}if(void 0!==mapViewModel.HoveredPolyine&&void 0!==mapViewModel.HoveredPolyine.DummyHandle){var n=mapViewModel.HoveredPolyine,r=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[0]),d=mapViewModel.Map.latLngToContainerPoint(n.getLatLngs()[1]);r.distanceTo(e.containerPoint)<20||d.distanceTo(e.containerPoint)<20?mapViewModel.HoveredPolyine=void 0:(mapViewModel.HoveredPolyine.DummyHandle.marker.setOpacity(.8),mapViewModel.HoveredPolyine.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,r,d)),!1))}}),this.Map.addEventListener("click",function(e){if(o.GetMapMode()===MapMode.RouteDrawing){var i=mapViewModel.CreateWaypoint(e.latlng,MarkerType.Waypoint),t=o.DrawingPolyline.Waypoints[0].Id();i.SaveToServer().done(function(e){ServerApi.WaypointConnections.Connect(e.Id,t)}),i.AddToPolyline(o.DrawingPolyline),addDummyHandle(o.DrawingPolyline),removeFromPolyline(o.DrawingPolyline,o.DrawingLatLng),o.DrawingPolyline=o.AddPolyline(i),o.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),o.DrawingPolyline.addLatLng(o.DrawingLatLng)}}),this.Map.addEventListener("dblclick",function(e){o.GetMapMode()===MapMode.RouteDrawing&&(e.originalEvent.cancelBubble=!0,e.originalEvent.preventDefault(),e.originalEvent.stopPropagation(),o.DrawingPolyline.addLatLng(e.latlng),o.DrawingLatLng=e.latlng)}),$(document).keyup(function(e){o.GetMapMode()===MapMode.RouteDrawing&&27===e.keyCode&&o.RemovePolyline(o.DrawingPolyline)}),this.Map.addEventListener("move",function(e){for(var i=0,t=o.WaypointMarkers;i<t.length;i++){var a=t[i];a.Point=o.Map.latLngToContainerPoint(a.getLatLng())}}),this.Map.addEventListener("zoom",function(e){for(var i=0,t=o.WaypointMarkers;i<t.length;i++){var a=t[i];a.Point=o.Map.latLngToContainerPoint(a.getLatLng())}})}return e.prototype.StartRoute=function(){var e=new ClientModel.Trip,o=new ClientModel.Tack,i=mapViewModel.HarbourHelper.Detail();o.Start(i),e.Tacks.push(o),mapViewModel.TripHelper.Editing(e),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map)},e.prototype.AddToRoute=function(){var e=mapViewModel.TripHelper.Editing(),o=mapViewModel.HarbourHelper.Editing(),i=new ClientModel.Tack,t=e.Tacks()[e.Tacks().length-1],a=t.Start();mapViewModel.CalculateDistances(o,a),t.Distance(a.RouteDistance());var n=a;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng);t.End(o),i.Start(o),e.Tacks.push(i)},e.prototype.RedrawTrip=function(){mapViewModel.Map.removeLayer(mapViewModel.routePolyline()),mapViewModel.routePolyline(L.polyline([],{color:"#009900"})),mapViewModel.routePolyline().addTo(mapViewModel.Map);for(var e=0,o=mapViewModel.TripHelper.Editing().Tacks();e<o.length;e++){var i=o[e],t=i.End(),a=i.Start();if(void 0!==t){mapViewModel.CalculateDistances(t,a),i.Distance(a.RouteDistance());var n=a;for(mapViewModel.routePolyline().addLatLng(n.LatLng);void 0!==n.RoutePrecessor();)n=n.RoutePrecessor(),mapViewModel.routePolyline().addLatLng(n.LatLng)}}},e.prototype.PullTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,i=o.indexOf(e),t=o()[i-1],a=e.End();e.End(t.Start()),t.End(a),i>1&&o()[i-2].End(e.Start()),o.splice(i-1,2,e,t),mapViewModel.RedrawTrip()},e.prototype.PushTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,i=o.indexOf(e),t=o()[i+1];e.End(t.End()),t.End(e.Start()),i>0&&o()[i-1].End(t.Start()),o.splice(i,2,t,e),mapViewModel.RedrawTrip()},e.prototype.RemoveTack=function(){var e=this,o=mapViewModel.TripHelper.Editing().Tacks,i=o.indexOf(e),t=o()[i-1];void 0!==t&&t.End(e.End()),o.remove(e),mapViewModel.RedrawTrip()},e.prototype.LoadData=function(){var e=this;ServerApi.Waypoints.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];if("Waypoint"===a.Type)e.Waypoints.push(mapViewModel.CreateWaypoint(MarkerType.Waypoint).LoadFromServerEntity(a));else if("Harbour"===a.Type){var n=mapViewModel.CreateHarbour().LoadFromServerEntity(a);e.Harbours.push(n)}}e.WaypointsLoaded=!0,e.InitializeModel()}),ServerApi.WaypointConnections.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.WaypointConnections.push(a)}e.WaypointConnectionsLoaded=!0,e.InitializeModel()}),ServerApi.Persons.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Persons.push((new ClientModel.Person).LoadFromServerEntity(a))}e.PersonsLoaded=!0,e.InitializeModel()}),ServerApi.Jobs.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Jobs.push((new ClientModel.Job).LoadFromServerEntity(a))}e.JobsLoaded=!0,e.InitializeModel()}),ServerApi.Trips.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Trips.push((new ClientModel.Trip).LoadFromServerEntity(a))}e.TripsLoaded=!0,e.InitializeModel()}),ServerApi.Addresses.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Addresses.push((new ClientModel.Address).LoadFromServerEntity(a))}e.AddressesLoaded=!0,e.InitializeModel()}),ServerApi.Images.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Images.push((new ClientModel.Image).LoadFromServerEntity(a))}e.ImagesLoaded=!0,e.InitializeModel()}),ServerApi.Albums.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Albums.push((new ClientModel.Album).LoadFromServerEntity(a))}e.AlbumsLoaded=!0,e.InitializeModel()}),ServerApi.LogBookEntries.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.LogBookEntries.push((new ClientModel.LogBookEntry).LoadFromServerEntity(a))}e.LogBookEntriesLoaded=!0,e.InitializeModel()}),ServerApi.AlbumImages.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.AlbumImages.push(a)}e.AlbumImagesLoaded=!0,e.InitializeModel()}),ServerApi.Crews.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Crews.push(a)}e.CrewsLoaded=!0,e.InitializeModel()}),ServerApi.Wifis.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Wifis.push((new ClientModel.Wifi).LoadFromServerEntity(a))}e.WifisLoaded=!0,e.InitializeModel()}),ServerApi.ContentPages.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.ContentPages.push((new ClientModel.ContentPage).LoadFromServerEntity(a))}e.ContentPagesLoaded=!0,e.InitializeModel()}),ServerApi.Tacks.Get().done(function(o){for(var i=0,t=o;i<t.length;i++){var a=t[i];e.Tacks.push((new ClientModel.Tack).LoadFromServerEntity(a))}e.TacksLoaded=!0,e.InitializeModel()}),this.LocationsLoaded=!0},e.prototype.InitializeModel=function(){if(this.WaypointsLoaded&&this.WaypointConnectionsLoaded&&this.PersonsLoaded&&this.JobsLoaded&&this.TripsLoaded&&this.AddressesLoaded&&this.ImagesLoaded&&this.AlbumsLoaded&&this.TacksLoaded&&this.LocationsLoaded&&this.CrewsLoaded&&this.LogBookEntriesLoaded&&this.AlbumImagesLoaded&&this.WifisLoaded&&this.ContentPagesLoaded){for(var e=0,o=this.Jobs();e<o.length;e++){var i=o[e];void 0!==i.AssignedToId()&&i.AssignedTo(this.GetPersonById(i.AssignedToId())),void 0!==i.TripId()&&i.Trip(this.GetTripById(i.TripId())),void 0!==i.SuperJobId()&&(i.SuperJob(this.GetJobById(i.SuperJobId())),i.SuperJob().SubJobs.push(i))}for(var t=0,a=this.Harbours();t<a.length;t++){var i=a[t];i.Album(this.GetAlbumById(i.AlbumId()))}for(var n=0,r=this.Locations();n<r.length;n++){var i=r[n];i.Address(this.GetAddressById(i.AddressId())),this.GetHarbourById(i.HarbourId()).Locations.push(i)}for(var d=0,l=this.AlbumImages();d<l.length;d++){var i=l[d];this.GetAlbumById(i.AlbumId).Images.push(this.GetImageById(i.ImageId))}for(var s=0,p=mapViewModel.WaypointConnections();s<p.length;s++){var u=p[s],m=mapViewModel.AddPolyline([mapViewModel.GetWayPointById(u.Waypoint1Id),mapViewModel.GetWayPointById(u.Waypoint2Id)]);addDummyHandle(m)}for(var g=0,M=mapViewModel.LogBookEntries();g<M.length;g++){var v=M[g];v.Start(mapViewModel.GetHarbourById(v.StartId())),v.End(mapViewModel.GetHarbourById(v.EndId())),v.Album(mapViewModel.GetAlbumById(v.AlbumId()))}for(var c=0,h=mapViewModel.Crews();c<h.length;c++){var y=h[c],w=mapViewModel.GetLogBookEntryById(y.TackId),f=mapViewModel.GetTackById(y.TackId),b=mapViewModel.GetTripById(y.TackId),L=mapViewModel.GetPersonById(y.PersonId);void 0!==w?w.Persons.push(L):void 0!==f?f.Persons.push(L):void 0!==b&&b.Persons.push(L)}for(var D=0,V=mapViewModel.Wifis();D<V.length;D++){var P=V[D],k=mapViewModel.GetHarbourById(P.HarbourId());k.Wifis.push(P),P.Harbour(k)}ko.applyBindings(mapViewModel),$("#loadingOverlay").remove()}},e.prototype.InitializeMap=function(){mapViewModel.HarbourHelper.Detail(void 0);for(var e=0,o=mapViewModel.Waypoints();e<o.length;e++){var i=o[e];void 0!==i.marker&&mapViewModel.Map.removeLayer(i.marker),mapViewModel.CreateMarker(MarkerType.Waypoint,i)}for(var t=0,a=mapViewModel.Harbours();t<a.length;t++){var n=a[t];void 0!==n.marker&&mapViewModel.Map.removeLayer(n.marker),mapViewModel.CreateMarker(MarkerType.Harbour,n)}for(var r=0,d=mapViewModel.Polylines;r<d.length;r++){var l=d[r];void 0!==l.DummyHandle.marker&&mapViewModel.Map.removeLayer(l.DummyHandle.marker),mapViewModel.CreateMarker(MarkerType.Dummy,l.DummyHandle)}if(mapViewModel.MapMode()===MapMode.Admin){for(var s=0,p=mapViewModel.Polylines;s<p.length;s++){var l=p[s];l.addTo(mapViewModel.Map)}mapViewModel.Map.contextmenu.enable()}else{for(var u=0,m=mapViewModel.Polylines;u<m.length;u++){var l=m[u];mapViewModel.Map.removeLayer(l)}mapViewModel.Map.contextmenu.disable()}},e.prototype.GetWaypointById=function(e){for(var o=0,i=this.Waypoints();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}for(var a=0,n=this.Harbours();a<n.length;a++){var t=n[a];if(t.Id()===e)return t}},e.prototype.GetHarbourById=function(e){for(var o=0,i=this.Harbours();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetPersonById=function(e){for(var o=0,i=this.Persons();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetJobById=function(e){for(var o=0,i=this.Jobs();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetTripById=function(e){for(var o=0,i=this.Trips();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetAddressById=function(e){for(var o=0,i=this.Addresses();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetImageById=function(e){for(var o=0,i=this.Images();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetTackById=function(e){for(var o=0,i=this.Tacks();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetLogBookEntryById=function(e){for(var o=0,i=this.LogBookEntries();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetAlbumById=function(e){for(var o=0,i=this.Albums();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}},e.prototype.GetLocationById=function(e){for(var o=0,i=this.Locations();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}for(var a=0,n=this.Restaurants();a<n.length;a++){var t=n[a];if(t.Id()===e)return t}for(var r=0,d=this.Restaurants();r<d.length;r++){var t=d[r];if(t.Id()===e)return t}},e.prototype.InitGallery=function(e,o){for(var i=new Array,t=o.target.parentElement,a=this,n=0,r=mapViewModel.AlbumStack()[0].Images();n<r.length;n++){var d=r[n];i.push({h:d.Height(),w:d.Width(),src:d.Path()})}gallery=new PhotoSwipe(pswp,PhotoSwipeUI_Default,i,{index:mapViewModel.AlbumStack()[0].Images.indexOf(a),getThumbBoundsFn:function(e){var o=$("img",t)[e],i=parseFloat(window.getComputedStyle(o,null).getPropertyValue("padding-left").replace("px",""));o.scrollIntoView(!1);var a=o.getBoundingClientRect();return{x:a.left+i,y:a.top+window.screenY+i,w:a.width-2*i}}}),gallery.init()},e.prototype.AddHarbour=function(){var e=mapViewModel.CreateHarbour("Hafen "+this.Harbours.length,this.Map.getCenter());mapViewModel.Harbours.push(e),e.SaveToServer()},e.prototype.AddPolyline=function(e){var o=new L.Polyline([]);if(mapViewModel.Polylines.push(o),o.addEventListener("click",function(e){var i=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[0]),t=mapViewModel.Map.latLngToContainerPoint(o.getLatLngs()[1]);o.DummyHandle.SetLatLng(mapViewModel.Map.containerPointToLatLng(L.LineUtil.closestPointOnSegment(e.containerPoint,i,t)),!1),mapViewModel.Waypoints.push(o.DummyHandle),o.DummyHandle.convertFromDummyHandle()}),mapViewModel.MapMode()===MapMode.Admin&&o.addTo(this.Map),o.Waypoints=new Array,void 0!==e)if(e instanceof Waypoint)e.AddToPolyline(o);else for(var i=0,t=e;i<t.length;i++){var a=t[i];a.AddToPolyline(o)}return o.addEventListener("mouseover",function(){mapViewModel.HoveredPolyine=o}),o},e.prototype.GetMapMode=function(){return void 0!==this.DrawingPolyline&&void 0!==this.DrawingLatLng?MapMode.RouteDrawing:this.MapMode()},e.prototype.GetWayPointById=function(e){for(var o=0,i=this.Waypoints();o<i.length;o++){var t=i[o];if(t.Id()===e)return t}for(var a=0,n=this.Harbours();a<n.length;a++){var t=n[a];if(t.Id()===e)return t}throw"No Waypoint with id "+e+" in model"},e.prototype.CalculateDistances=function(e,o){void 0===e&&(e=mapViewModel.HarbourHelper.Detail());var i=[e],t=new Array,a=new Array,n=void 0!==o;if(t.push(new WaypointDistance(void 0,e,0,i,n)),n){for(var r=0,d=mapViewModel.Waypoints();r<d.length;r++){var l=d[r];l.RoutePrecessor(void 0)}for(var s=0,p=mapViewModel.Harbours();s<p.length;s++){var u=p[s];u.RoutePrecessor(void 0)}}else{for(var m=0,g=mapViewModel.Waypoints();m<g.length;m++){var l=g[m];l.Precessor(void 0)}for(var M=0,v=mapViewModel.Harbours();M<v.length;M++){var u=v[M];u.Precessor(void 0)}}for(;t.length>0;){for(var c=Number.POSITIVE_INFINITY,h=void 0,y=0,w=t;y<w.length;y++){for(var l=w[y],f=0,b=l.ConnectedWayPoints;f<b.length;f++){var L=b[f];void 0!==(n?L.RoutePrecessor():L.Precessor())&&removeFromArray(l.ConnectedWayPoints,L)}if(0===l.ConnectedWayPoints.length)removeFromArray(t,l),a.push(l);else{var D=l.Distance+l.ConnectedWayPoints[0].LatLng.distanceTo(l.LatLng)/1.852;c>D&&(c=D,h=l)}}void 0!==h&&t.push(new WaypointDistance(h.Waypoint,h.ConnectedWayPoints.shift(),c,i,n))}if(n)for(var V=0,P=a;V<P.length;V++){var l=P[V];l.Waypoint.RouteDistance(Math.round(l.Distance/100)/10)}else for(var k=0,H=a;k<H.length;k++){var l=H[k];l.Waypoint.Distance(Math.round(l.Distance/100)/10)}},e.prototype.ShowRoute=function(e){if(void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.HideRoute()),void 0===e&&(e=this),e instanceof ClientModel.Harbour){var o=[e.LatLng],i=e.Distance();for(void 0!==i&&null!==i||(i=0);void 0!==e.Precessor();)e=e.Precessor(),o.push(e.LatLng);mapViewModel.highlightedRoute=L.polyline(o),mapViewModel.highlightedRoute.addTo(mapViewModel.Map),mapViewModel.highlightedRoute.bindLabel(i.toString()+" sm",{noHide:!0}),mapViewModel.FitBounds(mapViewModel.highlightedRoute.getBounds())}},e.prototype.FitBounds=function(e){var o=mapViewModel.Map,i=o.getBounds();i.contains(e)||(void 0===mapViewModel.previousBounds&&(mapViewModel.previousBounds=i),o.fitBounds(e))},e.prototype.HideRoute=function(e){if(void 0===e&&(e=!1),(!mapViewModel.routeFixed||e)&&void 0!==mapViewModel.highlightedRoute&&(mapViewModel.routeFixed=!1,mapViewModel.Map.removeLayer(mapViewModel.highlightedRoute),mapViewModel.highlightedRoute=void 0,!mapViewModel.noRevertToPreviousBounds&&void 0!==mapViewModel.previousBounds)){var o=mapViewModel.previousBounds;mapViewModel.previousBounds=void 0,window.setTimeout(function(){void 0===mapViewModel.previousBounds?mapViewModel.Map.fitBounds(o):mapViewModel.previousBounds=o},100)}},e.prototype.FixRoute=function(){mapViewModel.routeFixed=!0,mapViewModel.previousBounds=void 0},e.prototype.CreateWaypoint=function(e,o){var i;return i=void 0!==o?new Waypoint(e,o,mapViewModel.Map):new Waypoint(o,mapViewModel.Map),this.InitializeWaypoint(i,o),i},e.prototype.InitializeWaypoint=function(e,o){this.CreateMarker(o,e)},e.prototype.CreateMarker=function(e,o){if(mapViewModel.MapMode()===MapMode.Admin||e===MarkerType.Harbour){var i={draggable:mapViewModel.MapMode()===MapMode.Admin};e===MarkerType.Dummy&&(i.opacity=0),mapViewModel.MapMode()!==MapMode.Admin||e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(i.icon=new L.Icon({iconUrl:"/images/waypointhandle.png",iconSize:new L.Point(10,10,!0),className:"waypoint"})),mapViewModel.MapMode()===MapMode.Admin&&(i.contextmenu=!0,i.contextmenuInheritItems=!1,e===MarkerType.Harbour?i.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.HarbourHelper.Editing(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.HarbourHelper.Deleting(this)}}]:i.contextmenuItems=[{text:"Bearbeiten",context:o,callback:function(){mapViewModel.WaypointHelper.Editing(this)}},{text:"Löschen",context:o,callback:function(){mapViewModel.WaypointHelper.Deleting(this)}}]);var t=new L.Marker(o.LatLng,i);t.addTo(this.Map),t.Waypoint=o,o.marker=t,mapViewModel.MapMode()===MapMode.Admin?(e===MarkerType.Dummy&&t.addEventListener("mouseout",function(e){e.target.Waypoint.IsDummy()&&(mapViewModel.HoveredPolyine=void 0)}),t.addEventListener("drag",function(){o.SetLatLng(o.marker.getLatLng())}),e!==MarkerType.Waypoint&&e!==MarkerType.Dummy||(this.WaypointMarkers.push(o.marker),o.marker.Point=mapViewModel.Map.latLngToContainerPoint(o.LatLng)),o.marker.addEventListener("click",function(){o.IsDummy()&&(mapViewModel.HoveredPolyine=void 0,o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)),mapViewModel.GetMapMode()===MapMode.RouteDrawing&&(o.IsInPolyline(mapViewModel.DrawingPolyline)?(removePolyline(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0):(ServerApi.WaypointConnections.Connect(o.Id(),mapViewModel.DrawingPolyline.Waypoints[0].Id()),o.AddToPolyline(mapViewModel.DrawingPolyline),removeFromPolyline(mapViewModel.DrawingPolyline,mapViewModel.DrawingLatLng),addDummyHandle(mapViewModel.DrawingPolyline),mapViewModel.DrawingPolyline=void 0,mapViewModel.DrawingLatLng=void 0))}),o.marker.addEventListener("dblclick",function(e){mapViewModel.DrawingPolyline=mapViewModel.AddPolyline(o),mapViewModel.DrawingLatLng=new L.LatLng(e.latlng.lat,e.latlng.lng),mapViewModel.DrawingPolyline.addLatLng(mapViewModel.DrawingLatLng)}),e===MarkerType.Dummy&&o.marker.addOneTimeEventListener("drag",function(){o.convertFromDummyHandle(),mapViewModel.Waypoints.push(o)}),o.marker.addEventListener("dragend",function(){o.SaveToServer()})):e===MarkerType.Harbour&&(o.marker.addEventListener("mouseover",function(){void 0!==mapViewModel.HarbourHelper.Detail()&&mapViewModel.ShowRoute(o)}),o.marker.addEventListener("click",function(){return mapViewModel.HarbourHelper.Detail(o)}))}},e.prototype.CreateHarbour=function(e,o){var i;return i=void 0!==o?new Harbour(o,this.Map):new Harbour(this.Map),i.Name(e),this.InitializeWaypoint(i,MarkerType.Harbour),i},e.prototype.SetOptionKey=function(e,o){ko.applyBindingsToNode(e,{attr:{"data-id":o.Id}},o),ko.applyBindingsToNode(e,{attr:{value:o.Id}},o)},e}(),dropzoneModalOpenedByDrag=!1,dropzoneModal=$("#dropzoneModal"),jobOverviewModal=$("#jobOverviewModal"),personOverviewModal=$("#personOverviewModal"),dropzone,hasDrag=!1,uploadModalVisible=!1,pswp=$(".pswp")[0],personDeails=$("#personDetails"),deletePerson=$("#deletePerson"),leftSidebar=new Sidebar($("#leftSidebar")),rightSidebar=new Sidebar($("#rightSidebar")),bottomSidebar=new Sidebar($("#bottomSidebar")),harbourInfo=$("#harbourInfo"),mapViewModel=new MapViewModel(MapMode.View);Dropzone.options.dropzone={acceptedFiles:"image/jpeg,image/png",dictInvalidFileType:"Dieser Dateityp wird nicht unterstützt",dictDefaultMessage:"Dateien hier ablegen",init:function(){dropzone=this,dropzone.on("success",function(e,o){var i=(new ClientModel.Image).LoadFromServerEntity(o.Image);mapViewModel.Images.push(i),mapViewModel.GetAlbumById(o.AlbumId).Images.push(i)}),dropzone.on("queuecomplete",function(){dropzoneModalOpenedByDrag&&dropzoneModal.modal("hide")}),dropzone.on("dragover",function(){
hasDrag=!0})}},document.ondragenter=function(e){!mapViewModel.IsLoggedIn||uploadModalVisible||hasDrag||dropzoneModalOpenedByDrag||!dropzoneModal.is(":not(.in)")||"Files"!==e.dataTransfer.types[0]||void 0===mapViewModel.AlbumStack()[0]||(dropzoneModal.modal("show"),uploadModalVisible=!0,dropzoneModalOpenedByDrag=!0),hasDrag=!0,e.preventDefault(),e.stopPropagation()},document.ondragover=function(){hasDrag=!0},document.ondragleave=function(e){(uploadModalVisible&&hasDrag&&dropzoneModalOpenedByDrag&&0===dropzone.getQueuedFiles().length||0===dropzone.getUploadingFiles().length)&&(hasDrag=!1,window.setTimeout(function(){hasDrag||(dropzoneModal.modal("hide"),uploadModalVisible=!1)},1e3)),e.preventDefault(),e.stopPropagation()},dropzoneModal.on("hide.bs.modal",function(e){return dropzone.getQueuedFiles().length>0||dropzone.getUploadingFiles().length>0?(e.preventDefault(),e.stopImmediatePropagation(),alert("Das Fenster kann nicht geschlossen werden, während Dateien hochgeladen werden."),!1):(dropzone.removeAllFiles(),void(dropzoneModalOpenedByDrag=!1))});var gallery;$(".modal").on("hidden.bs.modal",function(){$(this).removeClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")-1)}),$(".modal").on("shown.bs.modal",function(){"undefined"==typeof $("body").data("fv_open_modals")&&$("body").data("fv_open_modals",0),$(this).hasClass("fv-modal-stack")||($(this).addClass("fv-modal-stack"),$("body").data("fv_open_modals",$("body").data("fv_open_modals")+1),$(this).css("z-index",1040+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not(".fv-modal-stack").css("z-index",1039+10*$("body").data("fv_open_modals")),$(".modal-backdrop").not("fv-modal-stack").addClass("fv-modal-stack"))}),ko.bindingHandlers.daterange={init:function(e,o,i,t,a){var n=o()();void 0===n&&o()((new Date).toJSON()),n=o()(),$(e).daterangepicker({singleDatePicker:!0,timePicker:!0,timePicker24Hour:!0,autoApply:!0,startDate:n,endDate:n},function(e){o()(e._d.toJSON())})},update:function(e,o,i,t,a){$(e).data("daterangepicker").setStartDate(moment(o()()))}},window.Parsley.on("form:validate",function(e){return void 0===e.submitEvent?!1:void 0}),window.Parsley.on("form:submit",function(e){return!1});
//# sourceMappingURL=Map.min.js.map
